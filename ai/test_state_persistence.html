<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>State Persistence Test</title>
</head>
<body>
    <h1>State Persistence Test</h1>
    <div id="test-results"></div>
    
    <script>
        // Test the state persistence functions
        function saveStateToStorage() {
            const state = {
                currentDatasetId: 'test-dataset-123',
                currentDatasetName: 'Test Dataset',
                currentSessionId: 'test-session-456',
                currentDatasetIndex: 0,
                lastUpdated: new Date().toISOString()
            };
            localStorage.setItem('dataflow_analytics_state', JSON.stringify(state));
            console.log('State saved to localStorage:', state);
            return state;
        }
        
        function loadStateFromStorage() {
            try {
                const savedState = localStorage.getItem('dataflow_analytics_state');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    
                    // Check if the saved state is not too old (24 hours)
                    const lastUpdated = new Date(state.lastUpdated);
                    const now = new Date();
                    const hoursDiff = (now - lastUpdated) / (1000 * 60 * 60);
                    
                    if (hoursDiff < 24) {
                        console.log('State restored from localStorage:', state);
                        return state;
                    } else {
                        console.log('Saved state is too old, clearing localStorage');
                        localStorage.removeItem('dataflow_analytics_state');
                    }
                }
            } catch (error) {
                console.error('Error loading state from localStorage:', error);
                localStorage.removeItem('dataflow_analytics_state');
            }
            return null;
        }
        
        function clearStateFromStorage() {
            localStorage.removeItem('dataflow_analytics_state');
            console.log('State cleared from localStorage');
        }
        
        // Run tests
        function runTests() {
            const results = document.getElementById('test-results');
            let testResults = '<h2>Test Results:</h2>';
            
            // Test 1: Save state
            console.log('=== Test 1: Save State ===');
            const testState = saveStateToStorage();
            testResults += '<p>✅ Test 1: State saved successfully</p>';
            
            // Test 2: Load state
            console.log('=== Test 2: Load State ===');
            const loadedState = loadStateFromStorage();
            if (loadedState && loadedState.currentDatasetId === testState.currentDatasetId) {
                testResults += '<p>✅ Test 2: State loaded successfully</p>';
            } else {
                testResults += '<p>❌ Test 2: State loading failed</p>';
            }
            
            // Test 3: Clear state
            console.log('=== Test 3: Clear State ===');
            clearStateFromStorage();
            const clearedState = loadStateFromStorage();
            if (!clearedState) {
                testResults += '<p>✅ Test 3: State cleared successfully</p>';
            } else {
                testResults += '<p>❌ Test 3: State clearing failed</p>';
            }
            
            // Test 4: Old state handling
            console.log('=== Test 4: Old State Handling ===');
            const oldState = {
                currentDatasetId: 'old-dataset',
                currentDatasetName: 'Old Dataset',
                currentSessionId: 'old-session',
                currentDatasetIndex: 0,
                lastUpdated: new Date(Date.now() - 25 * 60 * 60 * 1000).toISOString() // 25 hours ago
            };
            localStorage.setItem('dataflow_analytics_state', JSON.stringify(oldState));
            const oldLoadedState = loadStateFromStorage();
            if (!oldLoadedState) {
                testResults += '<p>✅ Test 4: Old state properly cleared</p>';
            } else {
                testResults += '<p>❌ Test 4: Old state not cleared</p>';
            }
            
            results.innerHTML = testResults;
            console.log('All tests completed');
        }
        
        // Run tests when page loads
        window.addEventListener('load', runTests);
    </script>
</body>
</html>
