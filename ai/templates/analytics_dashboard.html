{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analytics Dashboard - DataFlow Analytics</title>
    <link rel="stylesheet" href="{% static 'css/main.css' %}" />
    <meta name="description" content="Advanced analytics dashboard with AI-powered insights, real-time collaboration, and interactive data visualization." />
    <script src="https://d3js.org/d3.v7.min.js"></script>
<script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Fdataflowa6394back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.6"></script>

<style>
    /* Lightning highlight effect */
    .lightning-highlight {
        animation: lightning 0.5s ease-in-out;
        box-shadow: 0 0 20px #3b82f6, 0 0 40px #3b82f6, 0 0 60px #3b82f6;
        border-radius: 8px;
        padding: 8px;
        margin: -8px;
    }
    
    @keyframes lightning {
        0% {
            box-shadow: 0 0 5px #3b82f6;
            transform: scale(1);
        }
        50% {
            box-shadow: 0 0 30px #3b82f6, 0 0 60px #3b82f6, 0 0 90px #3b82f6;
            transform: scale(1.02);
        }
        100% {
            box-shadow: 0 0 20px #3b82f6, 0 0 40px #3b82f6, 0 0 60px #3b82f6;
            transform: scale(1);
        }
    }
    
    /* Resizable chat panel styles */
    .resizable-panel {
        transition: width 0.1s ease-out;
        min-width: 320px;
        max-width: 800px;
    }
    
    /* Resize handle styles - using Tailwind classes instead */
    
    /* Chat content resizing */
    .chat-content-resizable {
        transition: all 0.2s ease-out;
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        max-width: 100%;
    }
    
    .chat-message-expanded {
        max-width: 100% !important;
        width: 100% !important;
    }
    
    .chat-input-expanded {
        width: calc(100% - 1rem) !important;
    }
    
    /* AI Response Formatting Styles */
    .chat-content-resizable ul {
        margin-left: 1rem;
        margin-bottom: 0.75rem;
    }
    
    .chat-content-resizable li {
        margin-bottom: 0.25rem;
    }
    
    .chat-content-resizable h3 {
        color: #1e40af;
        font-weight: 600;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
    }
    
    .chat-content-resizable h4 {
        color: #1e40af;
        font-weight: 600;
        margin-top: 0.75rem;
        margin-bottom: 0.25rem;
    }
    
    .chat-content-resizable code {
        background-color: #f3f4f6;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-family: 'Courier New', monospace;
        font-size: 0.75rem;
    }
    
    .chat-content-resizable strong {
        font-weight: 600;
        color: #1e40af;
    }
    
    .chat-content-resizable em {
        font-style: italic;
    }
    
    /* Table formatting */
    .chat-content-resizable table {
        border-collapse: collapse;
        width: 100%;
        margin: 0.5rem 0;
        font-size: 0.875rem;
    }
    
    .chat-content-resizable table td {
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        text-align: left;
        vertical-align: top;
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: none;
    }
    
    .chat-content-resizable table tr:first-child td {
        background-color: #f3f4f6;
        font-weight: 600;
        color: #1e40af;
    }
    
    /* Better text wrapping for long content */
    .chat-content-resizable p {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
    }
    
    .chat-content-resizable li {
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    /* Ensure proper spacing for long content */
    .chat-content-resizable {
        overflow-wrap: break-word;
        word-wrap: break-word;
    }
</style>
</head>
<body class="bg-background">
    <!-- Top Navigation -->
    <nav class="bg-white shadow-subtle border-b border-border-light sticky top-0 z-50">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <svg class="h-8 w-8 text-primary mr-3" viewBox="0 0 32 32" fill="currentColor">
                        <path d="M4 8h6v16H4V8zm8-4h6v20h-6V4zm8 8h6v12h-6V12z"/>
                        <circle cx="26" cy="6" r="2" fill="currentColor"/>
                        <path d="M24 8l4 4-4 4" stroke="currentColor" stroke-width="2" fill="none"/>
                    </svg>
                    <span class="text-xl font-bold text-primary">DataFlow Analytics</span>
                </div>
                
                <!-- Dashboard Navigation -->
                <div class="hidden md:flex items-center space-x-6">
                    <button class="flex items-center text-primary font-medium">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v6H8V5z"/>
                        </svg>
                        Datasets
                    </button>
                    <button class="flex items-center text-text-secondary hover:text-primary transition-colors">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                        </svg>
                        Saved Analyses
                    </button>
                    <button class="flex items-center text-text-secondary hover:text-primary transition-colors">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        Collaborate
                    </button>
                    <button class="flex items-center text-text-secondary hover:text-primary transition-colors">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Export
                    </button>
                </div>
                
                <!-- User Menu -->
                <div class="flex items-center space-x-4">
                    <!-- Collaboration Indicators -->
                    <div class="hidden md:flex items-center space-x-2">
                        <div class="flex -space-x-2">
                            <img src="https://images.unsplash.com/photo-1494790108755-2616b612b786?q=80&w=32&h=32&auto=format&fit=crop&ixlib=rb-4.0.3" alt="Sarah Chen" class="w-8 h-8 rounded-full border-2 border-white object-cover" onerror="this.src='https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;" />
                            <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?q=80&w=32&h=32&auto=format&fit=crop&ixlib=rb-4.0.3" alt="Marcus Rodriguez" class="w-8 h-8 rounded-full border-2 border-white object-cover" onerror="this.src='https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;" />
                        </div>
                        <div class="w-2 h-2 bg-success rounded-full animate-pulse"></div>
                    </div>
                    
                    <!-- Main Navigation -->
                    <div class="hidden md:flex items-center space-x-4">
                        <a href="{% url 'homepage' %}" class="text-text-secondary hover:text-primary transition-colors">Home</a>
                        <a href="{% url 'pricing_plans' %}" class="text-text-secondary hover:text-primary transition-colors">Pricing</a>
                        <a href="{% url 'getting_started' %}" class="text-text-secondary hover:text-primary transition-colors">Get Started</a>
                        <a href="{% url 'account_management' %}" class="text-text-secondary hover:text-primary transition-colors">Account</a>
                    </div>
                    
                    <!-- User Avatar -->
                    <div class="relative">
                        <button class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-semibold">
                            JD
                        </button>
                    </div>
                    
                    <!-- Mobile Menu Button -->
                    <button class="md:hidden p-2 rounded-lg hover:bg-surface" id="mobile-menu-btn">
                        <svg class="h-6 w-6 text-text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Dashboard Container -->
    <div class="flex h-screen bg-background pt-16">
<!-- Left Panel - Statistical Parameters -->
        <div class="w-80 bg-white border-r border-border-light overflow-y-auto" id="left-panel">
            <div class="p-6">
                <!-- Current Dataset Information -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-primary">Current Dataset</h3>
                        <button class="text-secondary hover:text-secondary-600 transition-colors" title="Change Dataset" id="change-dataset-btn">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                        </button>
                    </div>
                    <div class="card p-4">
                        <div class="flex items-center mb-3">
                            <svg class="w-5 h-5 text-secondary mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            <span class="font-medium text-primary" id="dataset-name">Sales Performance Q4 2024</span>
                        </div>
                        <div class="space-y-2 text-sm text-text-secondary">
                            <div class="flex justify-between">
                                <span>Rows:</span>
                                <span class="font-medium text-primary" id="dataset-rows">1,247</span>
                        </div>
                            <div class="flex justify-between">
                                <span>Columns:</span>
                                <span class="font-medium text-primary" id="dataset-columns">8</span>
                            </div>
                            <div class="flex justify-between">
                                <span>File Size:</span>
                                <span class="font-medium text-primary" id="dataset-size">2.4 MB</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Last Updated:</span>
                                <span class="font-medium text-primary" id="dataset-updated">Jan 3, 2025</span>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-border-light">
                            <div class="flex items-center justify-between text-xs">
                                <span class="text-text-secondary">Status:</span>
                                <span class="flex items-center text-success">
                                    <div class="w-2 h-2 bg-success rounded-full mr-1"></div>
                                    Ready for Analysis
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dataset History -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-primary">Dataset History</h3>
                        <button class="text-xs text-secondary hover:text-primary transition-colors" id="multiselect-toggle" title="Toggle multiselect mode">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                        </button>
                    </div>
                    <div class="space-y-2 max-h-32 overflow-y-auto" id="dataset-history">
                        <!-- Dataset history items will be added here dynamically -->
                    </div>
                    <!-- Multiselect actions (hidden by default) -->
                    <div class="hidden mt-3 space-y-2" id="multiselect-actions">
                        <div class="flex items-center justify-between text-xs text-text-secondary">
                            <span id="selected-count">0 selected</span>
                            <button class="text-red-500 hover:text-red-700 transition-colors" onclick="deleteSelectedDatasets()">
                                Delete Selected
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Statistical Tests Menu -->
                <div class="mb-6 statistical-tests-section">
                    <h3 class="text-lg font-semibold text-primary mb-3">Statistical Tests</h3>
                    <div class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Descriptive Statistics -->
                        <div class="border-b border-border-light pb-2 mb-3">
                            <h4 class="text-sm font-semibold text-primary mb-2">Descriptive Statistics</h4>
                            <div class="space-y-1">
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="summary-stats">
                                    <div class="flex items-center justify-between">
                                        <span>Summary Statistics</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="frequency-tables">
                                    <div class="flex items-center justify-between">
                                        <span>Frequency Tables</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="percentiles">
                                    <div class="flex items-center justify-between">
                                        <span>Percentiles & Quartiles</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <!-- Parametric Tests -->
                        <div class="border-b border-border-light pb-2 mb-3">
                            <h4 class="text-sm font-semibold text-primary mb-2">Parametric Tests</h4>
                            <div class="space-y-1">
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="t-test-one">
                                    <div class="flex items-center justify-between">
                                        <span>One-Sample T-Test</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="t-test-two">
                                    <div class="flex items-center justify-between">
                                        <span>Two-Sample T-Test</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="paired-t-test">
                                    <div class="flex items-center justify-between">
                                        <span>Paired T-Test</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="anova-one-way">
                                    <div class="flex items-center justify-between">
                                        <span>One-Way ANOVA</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="anova-two-way">
                                    <div class="flex items-center justify-between">
                                        <span>Two-Way ANOVA</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="repeated-measures">
                                    <div class="flex items-center justify-between">
                                        <span>Repeated Measures ANOVA</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <!-- Non-Parametric Tests -->
                        <div class="border-b border-border-light pb-2 mb-3">
                            <h4 class="text-sm font-semibold text-primary mb-2">Non-Parametric Tests</h4>
                            <div class="space-y-1">
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="mann-whitney">
                                    <div class="flex items-center justify-between">
                                        <span>Mann-Whitney U Test</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="wilcoxon-signed">
                                    <div class="flex items-center justify-between">
                                        <span>Wilcoxon Signed-Rank</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="kruskal-wallis">
                                    <div class="flex items-center justify-between">
                                        <span>Kruskal-Wallis Test</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="friedman">
                                    <div class="flex items-center justify-between">
                                        <span>Friedman Test</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="kolmogorov-smirnov">
                                    <div class="flex items-center justify-between">
                                        <span>Kolmogorov-Smirnov</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <!-- Regression Analysis -->
                        <div class="border-b border-border-light pb-2 mb-3">
                            <h4 class="text-sm font-semibold text-primary mb-2">Regression Analysis</h4>
                            <div class="space-y-1">
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors bg-primary-50" data-test="linear-regression">
                                    <div class="flex items-center justify-between">
                                        <span>Linear Regression</span>
                                        <svg class="w-3 h-3 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="multiple-regression">
                                    <div class="flex items-center justify-between">
                                        <span>Multiple Regression</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="logistic-regression">
                                    <div class="flex items-center justify-between">
                                        <span>Logistic Regression</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="polynomial-regression">
                                    <div class="flex items-center justify-between">
                                        <span>Polynomial Regression</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="ridge-regression">
                                    <div class="flex items-center justify-between">
                                        <span>Ridge Regression</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <!-- Correlation & Association -->
                        <div class="border-b border-border-light pb-2 mb-3">
                            <h4 class="text-sm font-semibold text-primary mb-2">Correlation & Association</h4>
                            <div class="space-y-1">
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="pearson-correlation">
                                    <div class="flex items-center justify-between">
                                        <span>Pearson Correlation</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="spearman-correlation">
                                    <div class="flex items-center justify-between">
                                        <span>Spearman Correlation</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="chi-square">
                                    <div class="flex items-center justify-between">
                                        <span>Chi-Square Test</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="fishers-exact">
                                    <div class="flex items-center justify-between">
                                        <span>Fisher's Exact Test</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <!-- Time Series -->
                        <div class="border-b border-border-light pb-2 mb-3">
                            <h4 class="text-sm font-semibold text-primary mb-2">Time Series Analysis</h4>
                            <div class="space-y-1">
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="time-series">
                                    <div class="flex items-center justify-between">
                                        <span>Time Series Decomposition</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="arima">
                                    <div class="flex items-center justify-between">
                                        <span>ARIMA Models</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="seasonal-decomposition">
                                    <div class="flex items-center justify-between">
                                        <span>Seasonal Decomposition</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="autocorrelation">
                                    <div class="flex items-center justify-between">
                                        <span>Autocorrelation Analysis</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <!-- Survival Analysis -->
                        <div class="pb-2 mb-3">
                            <h4 class="text-sm font-semibold text-primary mb-2">Survival Analysis</h4>
                            <div class="space-y-1">
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="kaplan-meier">
                                    <div class="flex items-center justify-between">
                                        <span>Kaplan-Meier</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="cox-regression">
                                    <div class="flex items-center justify-between">
                                        <span>Cox Regression</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                                <button class="statistical-test-btn w-full text-left p-2 text-sm hover:bg-primary-50 rounded transition-colors" data-test="log-rank">
                                    <div class="flex items-center justify-between">
                                        <span>Log-Rank Test</span>
                                        <svg class="w-3 h-3 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Variable Selection -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-primary mb-3">Variables</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">Dependent Variable</label>
                            <select class="input-field">
                                <option>Revenue</option>
                                <option>Conversion Rate</option>
                                <option>Customer Satisfaction</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">Independent Variables</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" checked class="rounded border-border text-primary focus:ring-primary-300 mr-2" />
                                    <span class="text-sm">Marketing Spend</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" checked class="rounded border-border text-primary focus:ring-primary-300 mr-2" />
                                    <span class="text-sm">Seasonality</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="rounded border-border text-primary focus:ring-primary-300 mr-2" />
                                    <span class="text-sm">Product Category</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="rounded border-border text-primary focus:ring-primary-300 mr-2" />
                                    <span class="text-sm">Geographic Region</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistical Parameters -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-primary mb-3">Analysis Parameters</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">Selected Test</label>
                            <div class="p-3 bg-primary-50 rounded-lg border border-primary-200">
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 text-primary mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    <span class="text-sm font-medium text-primary" id="selected-test-name">Linear Regression</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">
                                Confidence Level: <span class="text-secondary font-semibold" id="confidence-value">95%</span>
                            </label>
                            <input type="range" min="90" max="99" value="95" class="w-full h-2 bg-border rounded-lg appearance-none cursor-pointer" id="confidence-slider" />
                            <div class="flex justify-between text-xs text-text-secondary mt-1">
                                <span>90%</span>
                                <span>99%</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">Sample Size</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" value="1247" class="input-field flex-1" readonly />
                                <button class="text-secondary hover:text-secondary-600 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" checked class="rounded border-border text-primary focus:ring-primary-300 mr-2" />
                                <span class="text-sm">Include outlier detection</span>
                            </label>
                        </div>
                        
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded border-border text-primary focus:ring-primary-300 mr-2" />
                                <span class="text-sm">Apply data transformation</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Data Filters -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-primary mb-3">Data Filters</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">Date Range</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="date" value="2024-10-01" class="input-field text-sm" />
                                <input type="date" value="2024-12-31" class="input-field text-sm" />
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">Region</label>
                            <select class="input-field">
                                <option>All Regions</option>
                                <option>North America</option>
                                <option>Europe</option>
                                <option>Asia Pacific</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="space-y-3">
                    <button class="btn-secondary w-full" id="run-analysis">
                        <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        Run Analysis
                    </button>
                    <button class="border-2 border-border text-text-primary px-6 py-3 rounded-lg font-semibold w-full hover:bg-surface transition-all duration-250">
                        <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Reset Parameters
                    </button>
                </div>
            </div>
        </div>

        <!-- Center Panel - Analysis Workspace -->
        <div class="flex-1 overflow-hidden" style="flex: 3;">
            <div class="h-full flex flex-col">
                <!-- Dataset Upload Section -->
                <div class="bg-white border-b border-border-light p-4" id="upload-section">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-primary">Dataset Management</h3>
                        <div class="flex items-center space-x-2">
                            <button class="text-secondary hover:text-secondary-600 transition-colors" title="Refresh Dataset">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Upload Area -->
                    <div class="border-2 border-dashed border-border-light rounded-lg p-6 text-center hover:border-primary transition-colors" id="upload-area">
                        <div class="flex flex-col items-center">
                            <svg class="w-12 h-12 text-text-secondary mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            <h4 class="text-lg font-medium text-text-primary mb-2">Upload Your Dataset</h4>
                            <p class="text-sm text-text-secondary mb-4">Drag and drop your CSV, Excel, or JSON file here, or click to browse</p>
                            <div class="flex items-center space-x-4">
                                <label class="btn-primary cursor-pointer">
                                    <input type="file" class="hidden" accept=".csv,.xlsx,.xls,.json" id="dataset-upload" />
                                    Choose File
                                </label>
                                <span class="text-xs text-text-secondary">Max 50MB</span>
                            </div>
                            <div class="mt-3 text-xs text-text-secondary">
                                Supported formats: CSV, Excel (.xlsx, .xls), JSON
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upload Progress (Hidden by default) -->
                    <div class="mt-4 hidden" id="upload-progress">
                        <div class="flex items-center space-x-3">
                            <div class="flex-1 bg-border-light rounded-full h-2">
                                <div class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%" id="progress-bar"></div>
                            </div>
                            <span class="text-sm text-text-secondary" id="progress-text">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Minimized Upload Section (Hidden by default) -->
                <div class="bg-white border-b border-border-light p-4 hidden" id="minimized-upload">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <button class="w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center hover:bg-primary-dark transition-colors" id="expand-upload">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                            </button>
                            <span class="text-sm text-text-secondary">Upload another dataset</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-text-secondary" id="dataset-count">1 dataset loaded</span>
                        </div>
                    </div>
                </div>

                <!-- Workspace Header -->
                <div class="bg-white border-b border-border-light p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <h2 class="text-xl font-semibold text-primary">Analysis Workspace</h2>
                            <div class="flex items-center text-sm text-success">
                                <div class="w-2 h-2 bg-success rounded-full mr-2 animate-pulse"></div>
                                Processing Complete
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="p-2 text-text-secondary hover:text-primary transition-colors" title="Fullscreen">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                                </svg>
                            </button>
                            <button class="p-2 text-text-secondary hover:text-primary transition-colors" title="Download Chart">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Visualization Area -->
                <div class="flex-1 p-6 overflow-auto" id="workspace-content">
                    <!-- Chart Tabs -->
                    <div class="flex space-x-1 mb-6 border-b border-border-light">
                        <button class="px-4 py-2 text-sm font-medium text-text-secondary hover:text-primary transition-colors" id="tab-distributions">
                            Distributions
                        </button>
                        <button class="px-4 py-2 text-sm font-medium text-text-secondary hover:text-primary transition-colors" id="tab-correlation">
                            Correlation Matrix
                        </button>
                        <button class="px-4 py-2 text-sm font-medium text-text-secondary hover:text-primary transition-colors" id="tab-outliers">
                            Outlier Analysis
                        </button>
                        <button class="px-4 py-2 text-sm font-medium text-text-secondary hover:text-primary transition-colors" id="tab-summary">
                            Summary Statistics
                        </button>
                    </div>

                    <!-- Summary Statistics Content (Hidden by default) -->
                    <div class="hidden" id="summary-statistics-content">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-primary">Summary Statistics</h3>
                            <button id="add-summary-to-report-btn" class="px-3 py-1 rounded text-xs"
                                    style="background-color:#2563eb;color:#ffffff;border:1px solid #1e40af;">Add summary to report</button>
                        </div>
                        <!-- Summary Overview -->
                    <div class="card mb-6">
                            <h3 class="text-lg font-semibold text-primary mb-4">Dataset Overview</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="text-center p-4 bg-primary-50 rounded-lg">
                                    <div class="text-2xl font-bold text-primary" id="total-rows">1,247</div>
                                    <div class="text-sm text-text-secondary">Total Rows</div>
                            </div>
                                <div class="text-center p-4 bg-secondary-50 rounded-lg">
                                    <div class="text-2xl font-bold text-secondary" id="total-columns">8</div>
                                    <div class="text-sm text-text-secondary">Total Columns</div>
                        </div>
                                <div class="text-center p-4 bg-success-50 rounded-lg">
                                    <div class="text-2xl font-bold text-success" id="numeric-columns">6</div>
                                    <div class="text-sm text-text-secondary">Numeric Columns</div>
                                </div>
                            </div>
                    </div>

                        <!-- Variable Summary Table -->
                        <div class="card mb-6">
                            <h3 class="text-lg font-semibold text-primary mb-4">Variable Summary</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="border-b border-border-light">
                                            <th class="text-left py-3 px-4 text-text-secondary font-medium">Variable</th>
                                            <th class="text-right py-3 px-4 text-text-secondary font-medium">Type</th>
                                            <th class="text-right py-3 px-4 text-text-secondary font-medium">Count</th>
                                            <th class="text-right py-3 px-4 text-text-secondary font-medium">Mean</th>
                                            <th class="text-right py-3 px-4 text-text-secondary font-medium">Std Dev</th>
                                            <th class="text-right py-3 px-4 text-text-secondary font-medium">Min</th>
                                            <th class="text-right py-3 px-4 text-text-secondary font-medium">25%</th>
                                            <th class="text-right py-3 px-4 text-text-secondary font-medium">Median</th>
                                            <th class="text-right py-3 px-4 text-text-secondary font-medium">75%</th>
                                            <th class="text-right py-3 px-4 text-text-secondary font-medium">Max</th>
                                        </tr>
                                    </thead>
                                    <tbody id="variable-summary-table">
                                        <!-- Variable rows will be populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Data Quality Report -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="card">
                                <h4 class="text-lg font-semibold text-primary mb-4">Data Quality</h4>
                            <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-text-secondary">Missing Values:</span>
                                        <span class="font-medium text-primary" id="missing-values">0.2%</span>
                                </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-text-secondary">Duplicate Rows:</span>
                                        <span class="font-medium text-primary" id="duplicate-rows">0</span>
                                </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-text-secondary">Outliers Detected:</span>
                                        <span class="font-medium text-warning" id="outliers-count">12</span>
                                </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-text-secondary">Data Completeness:</span>
                                        <span class="font-medium text-success" id="data-completeness">99.8%</span>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                                <h4 class="text-lg font-semibold text-primary mb-4">Distribution Insights</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-text-secondary">Skewed Variables:</span>
                                        <span class="font-medium text-primary" id="skewed-variables">2</span>
                            </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-text-secondary">Normal Distribution:</span>
                                        <span class="font-medium text-success" id="normal-distribution">4</span>
                        </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-text-secondary">High Variance:</span>
                                        <span class="font-medium text-warning" id="high-variance">1</span>
                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-text-secondary">Zero Variance:</span>
                                        <span class="font-medium text-text-secondary" id="zero-variance">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Chart Container -->
                    <div class="card mb-6" id="main-chart-container">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-primary">Data Visualization</h3>
                            <div class="flex items-center space-x-2 text-sm text-text-secondary">
                                <span>Interactive Charts</span>
                            </div>
                        </div>
                        <div id="main-chart" class="h-96 w-full"></div>
                    </div>

                    <!-- AI Data Pass Section -->
                    <div class="bg-white border-t border-border-light p-4" id="ai-data-section">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="text-sm font-medium text-primary">AI Assistant Ready</h4>
                                    <p class="text-xs text-text-secondary" id="ai-context-info">Click to pass current dataset and analysis context to AI</p>
                                </div>
                            </div>
                            <button class="btn-accent px-4 py-2 text-sm" id="pass-data-to-ai">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                </svg>
                                Pass Data to AI
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Right Panel - AI Chat Interface -->
        <div class="flex-1 bg-white border-l border-border-light flex flex-col relative" id="right-panel" style="flex: 2;">
            <!-- Resize Handle -->
            <div class="absolute left-0 top-0 bottom-0 w-3 bg-gray-300 hover:bg-blue-500 active:bg-blue-600 border-r border-gray-400 transition-colors z-10 select-none" id="resize-handle" title="Drag to resize" style="cursor: col-resize;"></div>
            <!-- Chat Header -->
            <div class="p-4 border-b border-border-light">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center mr-3">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-primary">AI Assistant</h3>
                            <p class="text-sm text-text-secondary">Statistical insights & guidance</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="download-report-btn" class="px-3 py-1 rounded text-xs"
                                style="background-color:#374151;color:#ffffff;border:1px solid #1f2937;">Download report</button>
                        <button class="p-2 text-text-secondary hover:text-primary transition-colors" title="Minimize Panel">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                        </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="flex-1 overflow-y-auto p-4 space-y-4" id="chat-messages">
                <!-- AI Welcome Message -->
                <div class="flex items-start">
                    <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div class="bg-accent-50 rounded-lg p-3 max-w-full chat-content-resizable">
                        <p class="text-sm text-text-primary">Hi! I'm here to help you interpret your dataset summary statistics. I can help you understand the data quality, distribution patterns, and variable characteristics. What would you like to explore?</p>
                    </div>
                </div>

                <!-- User Message -->
                <div class="flex items-start justify-end">
                    <div class="bg-primary rounded-lg p-3 max-w-full chat-content-resizable">
                        <p class="text-sm text-white">What does the R-squared value tell me about my model?</p>
                    </div>
                    <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center ml-3 flex-shrink-0 text-white font-semibold text-sm">
                        JD
                    </div>
                </div>

                <!-- AI Response -->
                <div class="flex items-start">
                    <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div class="bg-accent-50 rounded-lg p-3 max-w-full chat-content-resizable">
                        <p class="text-sm text-text-primary mb-2">Great question! Your R² of 0.847 means that 84.7% of the variation in revenue can be explained by your model variables (marketing spend and seasonality).</p>
                        <p class="text-sm text-text-primary mb-2">This is considered a <strong>strong relationship</strong> in business analytics. It suggests your model is quite reliable for predictions.</p>
                        <div class="bg-white rounded p-2 mt-2 border border-accent-200">
                            <p class="text-xs text-text-secondary">💡 <strong>Insight:</strong> The remaining 15.3% of variation might be explained by factors not in your model, like competitor actions or economic conditions.</p>
                        </div>
                    </div>
                </div>

                <!-- User Message -->
                <div class="flex items-start justify-end">
                    <div class="bg-primary rounded-lg p-3 max-w-full chat-content-resizable">
                        <p class="text-sm text-white">Should I be concerned about any assumptions in my regression model?</p>
                    </div>
                    <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center ml-3 flex-shrink-0 text-white font-semibold text-sm">
                        JD
                    </div>
                </div>

                <!-- AI Response -->
                <div class="flex items-start">
                    <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div class="bg-accent-50 rounded-lg p-3 max-w-full chat-content-resizable">
                        <p class="text-sm text-text-primary mb-2">Excellent thinking! Let me check the key assumptions:</p>
                        <div class="space-y-2">
                            <div class="flex items-center text-xs">
                                <div class="w-2 h-2 bg-success rounded-full mr-2"></div>
                                <span>Linearity: ✓ Good</span>
                            </div>
                            <div class="flex items-center text-xs">
                                <div class="w-2 h-2 bg-success rounded-full mr-2"></div>
                                <span>Independence: ✓ Good</span>
                            </div>
                            <div class="flex items-center text-xs">
                                <div class="w-2 h-2 bg-warning rounded-full mr-2"></div>
                                <span>Homoscedasticity: ⚠️ Check residuals</span>
                            </div>
                        </div>
                        <p class="text-sm text-text-primary mt-2">I recommend reviewing the residual plots tab to verify the homoscedasticity assumption.</p>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="p-4 border-t border-border-light">
                <div class="flex space-x-2">
                    <input type="text" placeholder="Ask about your analysis..." class="input-field flex-1 text-sm" id="chat-input" />
                    <button class="btn-accent px-4 py-2" id="send-message">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Quick Questions -->
                <div class="mt-3">
                    <p class="text-xs text-text-secondary mb-2">Quick questions:</p>
                    <div class="flex flex-wrap gap-1">
                        <button class="text-xs bg-surface text-text-secondary px-2 py-1 rounded hover:bg-primary hover:text-white transition-colors">
                            Interpret coefficients
                        </button>
                        <button class="text-xs bg-surface text-text-secondary px-2 py-1 rounded hover:bg-primary hover:text-white transition-colors">
                            Check assumptions
                        </button>
                        <button class="text-xs bg-surface text-text-secondary px-2 py-1 rounded hover:bg-primary hover:text-white transition-colors">
                            Improve model
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Responsive Overlay -->
    <div class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" id="mobile-overlay"></div>

    <!-- Contextual Help Tooltip -->
    <div class="fixed bg-primary text-white p-3 rounded-lg shadow-lg text-sm max-w-xs hidden z-50" id="help-tooltip">
        <div class="flex items-start">
            <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>
            </svg>
            <div>
                <p class="font-medium mb-1">Statistical Tip</p>
                <p id="tooltip-content">Hover over elements to get contextual help and explanations.</p>
            </div>
        </div>
    </div>

    <script>
        // Dashboard Functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Add CSRF token to all AJAX requests
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfToken) {
                const token = document.createElement('input');
                token.type = 'hidden';
                token.name = 'csrfmiddlewaretoken';
                token.value = '{{ csrf_token }}';
                document.body.appendChild(token);
            }
            
            // Initialize D3 Chart
            initializeChart();
            
            // File Upload Functionality
            const fileUpload = document.getElementById('dataset-upload');
            const uploadProgress = document.getElementById('upload-progress');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const uploadArea = document.getElementById('upload-area');
            const uploadSection = document.getElementById('upload-section');
            const minimizedUpload = document.getElementById('minimized-upload');
            const expandUploadBtn = document.getElementById('expand-upload');
            const datasetCount = document.getElementById('dataset-count');
            const changeDatasetBtn = document.getElementById('change-dataset-btn');
            const datasetHistory = document.getElementById('dataset-history');
            
            // Dataset storage
            let datasets = [];
            let currentDatasetIndex = -1; // Start with no dataset selected
            
            // State persistence functions
            function saveStateToStorage() {
                const state = {
                    currentDatasetId: window.currentDatasetId,
                    currentDatasetName: window.currentDatasetName,
                    currentSessionId: window.currentSessionId,
                    currentDatasetIndex: currentDatasetIndex,
                    lastUpdated: new Date().toISOString()
                };
                // Use user-specific key to prevent cross-user data leakage
                const userKey = `dataflow_analytics_state_${window.currentUserId || 'anonymous'}`;
                localStorage.setItem(userKey, JSON.stringify(state));
                console.log('State saved to localStorage:', state);
                
                // Also save UI state to database
                saveUIStateToDatabase(state);
            }
            
            // New function to save UI state to database
            function saveUIStateToDatabase(state) {
                const formData = new FormData();
                formData.append('ui_state', JSON.stringify(state));
                
                fetch('{% url "save_ui_state" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('UI state saved to database:', state);
                    } else {
                        console.error('Error saving UI state to database:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error saving UI state to database:', error);
                });
            }
            
            function loadStateFromStorage() {
                try {
                    // Use user-specific key to prevent cross-user data leakage
                    const userKey = `dataflow_analytics_state_${window.currentUserId || 'anonymous'}`;
                    const savedState = localStorage.getItem(userKey);
                    if (savedState) {
                        const state = JSON.parse(savedState);
                        
                        // Check if the saved state is not too old (24 hours)
                        const lastUpdated = new Date(state.lastUpdated);
                        const now = new Date();
                        const hoursDiff = (now - lastUpdated) / (1000 * 60 * 60);
                        
                        if (hoursDiff < 24) {
                            window.currentDatasetId = state.currentDatasetId;
                            window.currentDatasetName = state.currentDatasetName;
                            window.currentSessionId = state.currentSessionId;
                            currentDatasetIndex = state.currentDatasetIndex;
                            console.log('State restored from localStorage:', state);
                            return true;
                        } else {
                            console.log('Saved state is too old, clearing localStorage');
                            localStorage.removeItem(userKey);
                        }
                    }
                } catch (error) {
                    console.error('Error loading state from localStorage:', error);
                    const userKey = `dataflow_analytics_state_${window.currentUserId || 'anonymous'}`;
                    localStorage.removeItem(userKey);
                }
                return false;
            }
            
            function clearStateFromStorage() {
                // Clear state for all potential user keys
                const userKey = `dataflow_analytics_state_${window.currentUserId || 'anonymous'}`;
                localStorage.removeItem(userKey);
                // Also clear the old generic key for backward compatibility
                localStorage.removeItem('dataflow_analytics_state');
                console.log('State cleared from localStorage');
            }
            
            // Enhanced loadUserState function with state persistence
            function loadUserState() {
                // First try to load from localStorage
                const stateRestored = loadStateFromStorage();
                
                fetch('{% url "get_user_state" %}')
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error('Error loading user state:', data.error);
                            showBlankState();
                            return;
                        }
                        
                        // Load datasets
                        datasets = data.datasets || [];
                        
                        // Use database session ID if available, otherwise fall back to localStorage
                        if (data.current_session_id) {
                            window.currentSessionId = data.current_session_id;
                            console.log('Using database session ID:', window.currentSessionId);
                        }
                        
                        // If we restored state from localStorage, use it
                        if (stateRestored && window.currentDatasetId) {
                            // Verify the dataset still exists
                            const datasetExists = datasets.find(d => d.id === window.currentDatasetId);
                            if (datasetExists) {
                                currentDatasetIndex = datasets.indexOf(datasetExists);
                                console.log('Using restored state with dataset:', window.currentDatasetId);
                            } else {
                                // Dataset no longer exists, use backend state
                                currentDatasetIndex = data.current_dataset_index || -1;
                                if (currentDatasetIndex >= 0 && datasets[currentDatasetIndex]) {
                                    window.currentDatasetId = datasets[currentDatasetIndex].id;
                                    window.currentDatasetName = datasets[currentDatasetIndex].name;
                                }
                                console.log('Dataset no longer exists, using backend state');
                            }
                        } else {
                            // Use backend state
                            currentDatasetIndex = data.current_dataset_index || -1;
                            if (currentDatasetIndex >= 0 && datasets[currentDatasetIndex]) {
                                window.currentDatasetId = datasets[currentDatasetIndex].id;
                                window.currentDatasetName = datasets[currentDatasetIndex].name;
                            }
                        }
                        
                        // Apply UI state from database if available
                        if (data.ui_state && Object.keys(data.ui_state).length > 0) {
                            console.log('Applying UI state from database:', data.ui_state);
                            // You can add more UI state restoration here as needed
                        }
                        
                        // Update displays
                        updateCurrentDatasetDisplay();
                        updateDatasetHistory();
                        updateDatasetCount();
                        
                        // If a current dataset exists, ensure backend sets/returns active session and capture its id
                        if (currentDatasetIndex >= 0 && datasets[currentDatasetIndex]) {
                            saveCurrentDataset(datasets[currentDatasetIndex].id);
                        }

                        // Show appropriate state - showBlankState() now handles the logic correctly
                        showBlankState();
                        
                        // Load chat history for current dataset if available
                        if (currentDatasetIndex >= 0 && datasets[currentDatasetIndex]) {
                            loadChatHistory();
                        }
                        
                        // Save state to localStorage
                        saveStateToStorage();
                        
                        console.log('User state loaded:', {
                            datasets: datasets.length,
                            currentIndex: currentDatasetIndex,
                            currentDatasetId: window.currentDatasetId
                        });
                    })
                    .catch(error => {
                        console.error('Error loading user state:', error);
                        showBlankState();
                    });
            }
            
            // Enhanced saveCurrentDataset function with state persistence
            function saveCurrentDataset(datasetId) {
                const formData = new FormData();
                formData.append('dataset_id', datasetId);
                
                fetch('{% url "set_current_dataset" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Current dataset saved:', data.message);
                        // Capture active session id for reporting/AI context
                        if (data.session_id) {
                            window.currentSessionId = data.session_id;
                        }
                        // Ensure local dataset id/name are set
                        window.currentDatasetId = datasetId;
                        const ds = datasets.find(d => d.id === datasetId);
                        if (ds) { 
                            window.currentDatasetName = ds.name;
                            currentDatasetIndex = datasets.indexOf(ds);
                        }
                        
                        // Save state to localStorage
                        saveStateToStorage();
                    } else {
                        console.error('Error saving current dataset:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error saving current dataset:', error);
                });
            }
            
            // Function to record interaction
            function recordInteraction(type, description, metadata = {}) {
                const formData = new FormData();
                formData.append('type', type);
                formData.append('description', description);
                formData.append('metadata', JSON.stringify(metadata));
                
                fetch('{% url "record_interaction" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Interaction recorded:', type);
                    } else {
                        console.error('Error recording interaction:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error recording interaction:', error);
                });
            }
            

            
            // Expand upload section
            expandUploadBtn.addEventListener('click', function() {
                uploadSection.classList.remove('hidden');
                minimizedUpload.classList.add('hidden');
            });
            
            // Change dataset button
            changeDatasetBtn.addEventListener('click', function() {
                showDatasetSelector();
            });
            
            function showDatasetSelector() {
                // Create modal or dropdown to select from dataset history
                const selector = document.createElement('div');
                selector.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
                selector.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4 relative">
                        <!-- Close button -->
                        <button class="absolute top-3 right-3 text-text-secondary hover:text-primary transition-colors" onclick="closeDatasetSelector()">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                        
                        <h3 class="text-lg font-semibold text-primary mb-4">Select Dataset</h3>
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            ${datasets.map((dataset, index) => `
                                <div class="flex items-center justify-between p-3 border border-border-light rounded-lg hover:bg-surface cursor-pointer ${index === currentDatasetIndex ? 'bg-primary-50 border-primary' : ''}" onclick="switchDataset(${index})">
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 text-secondary mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                        </svg>
                                        <div>
                                            <div class="font-medium text-text-primary">${dataset.name}</div>
                                            <div class="text-xs text-text-secondary">${dataset.rows} rows × ${dataset.columns} columns</div>
                                        </div>
                                    </div>
                                    ${index === currentDatasetIndex ? '<div class="w-2 h-2 bg-primary rounded-full"></div>' : ''}
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button class="text-text-secondary hover:text-primary transition-colors" onclick="closeDatasetSelector()">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(selector);
            }
            
            // Global functions for dataset switching
            window.switchDataset = function(index) {
                currentDatasetIndex = index;
                
                // Save current dataset to backend
                if (datasets[index]) {
                    saveCurrentDataset(datasets[index].id);
                    
                    // Set current dataset for AI chat
                    currentDatasetId = datasets[index].id;
                    currentDatasetName = datasets[index].name;
                    
                    // Update AI context info
                    if (aiContextInfo) {
                        aiContextInfo.textContent = `Dataset: ${datasets[index].name} | Analysis: ${currentAnalysisType || 'Summary Statistics'}`;
                    }
                    
                    // Reset AI data button if dataset changes
                    if (passDataButton) {
                        passDataButton.disabled = false;
                        passDataButton.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>Pass Data to AI';
                        passDataButton.classList.remove('bg-success', 'text-white');
                        passDataButton.classList.add('btn-accent');
                    }
                    
                    // Record the dataset switch interaction
                    recordInteraction('dataset_switch', `Switched to dataset: ${datasets[index].name}`, {
                        dataset_id: datasets[index].id,
                        dataset_name: datasets[index].name
                    });
                    
                    // Check if this dataset has summary statistics analysis
                    checkAnalysisHistory(datasets[index].id);
                }
                
                // Minimize upload section when switching datasets
                minimizeUploadSection();
                
                updateCurrentDatasetDisplay();
                updateDatasetHistory();
                closeDatasetSelector();
            };
            
            function checkAnalysisHistory(datasetId) {
                fetch(`{% url "get_analysis_history" 0 %}`.replace('0', datasetId))
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.analysis_history.length > 0) {
                            // Check if summary statistics exists
                            const hasSummaryStats = data.analysis_history.some(analysis => 
                                analysis.analysis_type === 'summary_stats' && analysis.is_complete
                            );
                            
                            if (hasSummaryStats) {
                                // Show summary statistics automatically
                                showSummaryStatistics();
                            } else {
                                // Show blank state with analysis options
                                showBlankState();
                            }
                        } else {
                            // No analysis history, show blank state
                            showBlankState();
                        }
                    })
                    .catch(error => {
                        console.error('Error checking analysis history:', error);
                        showBlankState();
                    });
            }
            
            window.closeDatasetSelector = function() {
                const selector = document.querySelector('.fixed.inset-0');
                if (selector) {
                    selector.remove();
                }
            };
            
            function updateCurrentDatasetDisplay() {
                if (currentDatasetIndex === -1 || datasets.length === 0) {
                    // No dataset selected, show placeholder or blank state
                    document.getElementById('dataset-name').textContent = 'No dataset selected';
                    document.getElementById('dataset-rows').textContent = '0';
                    document.getElementById('dataset-columns').textContent = '0';
                    document.getElementById('dataset-size').textContent = '0 MB';
                    document.getElementById('dataset-updated').textContent = 'N/A';
                    return;
                }
                
                const currentDataset = datasets[currentDatasetIndex];
                document.getElementById('dataset-name').textContent = currentDataset.name;
                document.getElementById('dataset-rows').textContent = currentDataset.rows.toLocaleString();
                document.getElementById('dataset-columns').textContent = currentDataset.columns;
                document.getElementById('dataset-size').textContent = currentDataset.size;
                document.getElementById('dataset-updated').textContent = currentDataset.updated;
            }
            
            function updateDatasetHistory() {
                if (datasets.length === 0) {
                    datasetHistory.innerHTML = `
                        <div class="text-center py-4 text-text-secondary">
                            <svg class="w-8 h-8 mx-auto mb-2 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            <p class="text-sm">No datasets uploaded yet</p>
                        </div>
                    `;
                    return;
                }
                
                datasetHistory.innerHTML = datasets.map((dataset, index) => {
                    const isSelected = selectedDatasets.has(dataset.id);
                    const isCurrent = index === currentDatasetIndex;
                    
                    return `
                        <div class="flex items-center justify-between p-2 border border-border-light rounded-lg hover:bg-surface cursor-pointer ${
                            multiselectMode ? 
                                (isSelected ? 'bg-blue-50 border-blue-300' : '') :
                                (isCurrent ? 'bg-primary-50 border-primary' : '')
                        }" onclick="${multiselectMode ? `toggleDatasetSelection(${dataset.id})` : `switchDataset(${index})`}">
                            <div class="flex items-center flex-1">
                                ${multiselectMode ? `
                                    <input type="checkbox" class="rounded border-border text-primary focus:ring-primary-300 mr-2" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleDatasetSelection(${dataset.id})">
                                ` : `
                                    <svg class="w-3 h-3 text-secondary mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                    </svg>
                                `}
                                <div class="text-xs flex-1">
                                    <div class="font-medium text-text-primary">${dataset.name}</div>
                                    <div class="text-text-secondary">${dataset.rows} rows</div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-1">
                                ${!multiselectMode && isCurrent ? '<div class="w-2 h-2 bg-primary rounded-full"></div>' : ''}
                                ${!multiselectMode ? `
                                    <button class="text-red-500 hover:text-red-700 transition-colors p-1" onclick="event.stopPropagation(); deleteDataset(${dataset.id}, '${dataset.name}')" title="Delete dataset">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Debug: Check if upload area is found
            console.log('Upload area found:', uploadArea);
            console.log('File upload element found:', fileUpload);
            console.log('Upload section found:', uploadSection);
            console.log('Minimized upload found:', minimizedUpload);
            
            // Check if elements are visible
            if (uploadArea) {
                console.log('Upload area classes:', uploadArea.className);
                console.log('Upload area style display:', uploadArea.style.display);
            }
            if (uploadSection) {
                console.log('Upload section classes:', uploadSection.className);
                console.log('Upload section hidden:', uploadSection.classList.contains('hidden'));
            }
            
            // Drag and drop functionality
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('border-primary');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('border-primary');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('border-primary');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
            
            // File input change
            fileUpload.addEventListener('change', function(e) {
                console.log('File input change event triggered');
                if (e.target.files.length > 0) {
                    console.log('File selected:', e.target.files[0].name);
                    handleFileUpload(e.target.files[0]);
                }
            });
            
            // Add click handler to upload area for testing
            uploadArea.addEventListener('click', function(e) {
                console.log('Upload area clicked');
                // Don't trigger file input if clicking on the label
                if (e.target.tagName !== 'LABEL' && e.target.tagName !== 'INPUT') {
                    console.log('Clicking file input');
                    fileUpload.click();
                }
            });
            
            function handleFileUpload(file) {
                console.log('handleFileUpload called with file:', file.name);
                
                // Validate file type
                const allowedTypes = ['.csv', '.xlsx', '.xls', '.json'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                
                if (!allowedTypes.includes(fileExtension)) {
                    alert('Please upload a valid file type: CSV, Excel, or JSON');
                    return;
                }
                
                // Validate file size (50MB limit)
                if (file.size > 50 * 1024 * 1024) {
                    alert('File size must be less than 50MB');
                    return;
                }
                
                // Show progress
                uploadProgress.classList.remove('hidden');
                
                // Create FormData for file upload
                const formData = new FormData();
                formData.append('file', file);
                
                // Upload file to backend
                fetch('{% url "upload_dataset" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Add new dataset to history
                        addNewDatasetFromBackend(data);
                        
                        // Minimize upload section
                        minimizeUploadSection();
                        
                        // Hide progress after a delay
                        setTimeout(() => {
                            uploadProgress.classList.add('hidden');
                        }, 1000);
                        
                        // Show success message
                        const successMessage = document.createElement('div');
                        successMessage.className = 'mt-3 p-3 bg-green-100 text-green-700 rounded-lg text-sm';
                        successMessage.textContent = data.message;
                        uploadArea.parentElement.appendChild(successMessage);
                        
                        // Remove success message after 3 seconds
                        setTimeout(() => {
                            successMessage.remove();
                        }, 3000);
                    } else {
                        alert('Upload failed: ' + data.error);
                        uploadProgress.classList.add('hidden');
                    }
                })
                .catch(error => {
                    console.error('Upload error:', error);
                    alert('Upload failed. Please try again.');
                    uploadProgress.classList.add('hidden');
                });
            }
            
            function addNewDatasetFromBackend(data) {
                // Create new dataset object from backend response
                const newDataset = {
                    id: data.dataset_id,
                    name: data.name,
                    rows: data.rows,
                    columns: data.columns,
                    size: data.file_size,
                    updated: new Date().toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    }),
                    file: null
                };
                
                // Add to datasets array
                datasets.push(newDataset);
                
                // Set as current dataset
                currentDatasetIndex = datasets.length - 1;
                
                // Save current dataset to backend
                saveCurrentDataset(newDataset.id);
                
                // Record the upload interaction
                recordInteraction('upload', `Uploaded dataset: ${newDataset.name}`, {
                    dataset_id: newDataset.id,
                    rows: newDataset.rows,
                    columns: newDataset.columns,
                    file_size: newDataset.size
                });
                
                // Update displays
                updateCurrentDatasetDisplay();
                updateDatasetHistory();
                updateDatasetCount();
            }
            
            function minimizeUploadSection() {
                uploadSection.classList.add('hidden');
                minimizedUpload.classList.remove('hidden');
            }
            
            function updateDatasetCount() {
                if (datasets.length === 0) {
                    datasetCount.textContent = 'No datasets loaded';
                } else {
                    datasetCount.textContent = `${datasets.length} dataset${datasets.length > 1 ? 's' : ''} loaded`;
                }
            }
            
            // Statistical test selection functionality
            const statisticalTestBtns = document.querySelectorAll('.statistical-test-btn');
            const selectedTestName = document.getElementById('selected-test-name');
            
            statisticalTestBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active state from all buttons
                    statisticalTestBtns.forEach(b => {
                        b.classList.remove('bg-primary-50');
                        const arrow = b.querySelector('svg');
                        arrow.classList.remove('text-primary');
                        arrow.classList.add('text-text-secondary');
                        // Change check icon back to arrow
                        arrow.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>';
                    });
                    
                    // Add active state to clicked button
                    this.classList.add('bg-primary-50');
                    const arrow = this.querySelector('svg');
                    arrow.classList.remove('text-text-secondary');
                    arrow.classList.add('text-primary');
                    // Change arrow to check icon
                    arrow.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>';
                    
                    // Update selected test name
                    const testName = this.querySelector('span').textContent;
                    selectedTestName.textContent = testName;
                    
                    // Handle different statistical tests
                    const testType = this.getAttribute('data-test');
                    handleStatisticalTest(testType);
                });
            });
            
            function handleStatisticalTest(testType) {
                // Hide all content sections
                document.getElementById('summary-statistics-content').classList.add('hidden');
                document.getElementById('main-chart-container').classList.add('hidden');
                
                // Check if there's a current dataset
                if (datasets.length === 0 || currentDatasetIndex === -1) {
                    // No dataset uploaded, show blank state
                    showBlankState();
                    return;
                }
                
                // Remove blank state message if it exists
                const blankStateMessage = document.querySelector('.blank-state-message');
                if (blankStateMessage) {
                    blankStateMessage.remove();
                }
                
                // Record the analysis type interaction
                const currentDataset = datasets[currentDatasetIndex];
                if (currentDataset) {
                    recordInteraction('analysis_type', `Selected analysis type: ${testType}`, {
                        dataset_id: currentDataset.id,
                        dataset_name: currentDataset.name,
                        analysis_type: testType
                    });
                }
                
                // Show appropriate content based on test type
                if (testType === 'summary-stats') {
                    showSummaryStatistics();
                } else {
                    // For other tests, show the main chart container
                    document.getElementById('main-chart-container').classList.remove('hidden');
                    updateChart(testType);
                }
            }
            
            function showBlankState() {
                // Hide all content sections
                document.getElementById('summary-statistics-content').classList.add('hidden');
                document.getElementById('main-chart-container').classList.add('hidden');
                
                // Show blank state message
                const workspaceContent = document.getElementById('workspace-content');
                const existingBlankState = workspaceContent.querySelector('.blank-state-message');
                
                if (!existingBlankState) {
                    const blankStateDiv = document.createElement('div');
                    blankStateDiv.className = 'blank-state-message flex flex-col items-center justify-center h-full py-12';
                    
                    // Check if we have a current dataset
                    const hasDataset = datasets.length > 0;
                    
                    blankStateDiv.innerHTML = `
                        <div class="w-24 h-24 bg-accent-50 rounded-full flex items-center justify-center mb-6">
                            <svg class="w-12 h-12 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-primary mb-2">${hasDataset ? 'Ready to Analyze!' : 'Start Your Analysis'}</h3>
                        <p class="text-text-secondary text-center max-w-md mb-6">
                            ${hasDataset ? 
                                'Your dataset is loaded and ready! Click the lightning button to explore powerful statistical tests.' : 
                                'Upload a dataset and select a statistical test from the left panel to begin your analysis.'
                            }
                        </p>
                        <div class="flex space-x-4">
                            ${!hasDataset ? `
                                <button class="px-6 py-2 bg-accent text-white rounded-lg hover:bg-accent-dark transition-colors" onclick="scrollToUpload()">
                                    Upload Dataset
                                </button>
                                <button class="px-6 py-2 border border-border-light text-text-primary rounded-lg hover:bg-surface transition-colors" onclick="showDatasetHistory()">
                                    View History
                                </button>
                            ` : `
                                <button class="px-6 py-2 bg-accent text-white rounded-lg hover:bg-accent-dark transition-colors flex items-center space-x-2 animate-pulse" onclick="highlightAnalysisSection()">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                    </svg>
                                    <span>Start Your Analysis</span>
                                </button>
                            `}
                        </div>
                    `;
                    workspaceContent.appendChild(blankStateDiv);
                }
            }
            
            function scrollToUpload() {
                // Scroll to the upload section
                const uploadSection = document.getElementById('upload-section');
                if (uploadSection) {
                    uploadSection.scrollIntoView({ behavior: 'smooth' });
                }
            }
            
            function scrollToLeftPanel() {
                // Scroll to the left panel
                const leftPanel = document.getElementById('left-panel');
                if (leftPanel) {
                    leftPanel.scrollIntoView({ behavior: 'smooth' });
                }
            }
            
            // Function to show dataset history (same as dataset selector)
            window.showDatasetHistory = function() {
                showDatasetSelector();
            };
            
            // Function to highlight analysis section with lightning effect
            window.highlightAnalysisSection = function() {
                const leftPanel = document.getElementById('left-panel');
                if (!leftPanel) return;
                
                // Scroll to left panel
                leftPanel.scrollIntoView({ behavior: 'smooth' });
                
                // Add lightning effect to the statistical tests section
                const statisticalTestsSection = leftPanel.querySelector('.statistical-tests-section');
                if (statisticalTestsSection) {
                    // Add lightning animation class
                    statisticalTestsSection.classList.add('lightning-highlight');
                    
                    // Remove the effect after 3 seconds
                        setTimeout(() => {
                        statisticalTestsSection.classList.remove('lightning-highlight');
                    }, 3000);
                }
            };
            
            // Global variables for warning preferences and multiselect
            let warningPreferences = {
                show_delete_warning: true,
                show_multiselect_help: true
            };
            let multiselectMode = false;
            let selectedDatasets = new Set();
            
            // Load warning preferences
            function loadWarningPreferences() {
                fetch('{% url "get_warning_preferences" %}')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            warningPreferences = {
                                show_delete_warning: data.show_delete_warning,
                                show_multiselect_help: data.show_multiselect_help
                            };
                        }
                    })
                    .catch(error => {
                        console.error('Error loading warning preferences:', error);
                    });
            }
            
            // Delete dataset function
            window.deleteDataset = function(datasetId, datasetName) {
                if (warningPreferences.show_delete_warning) {
                    showDeleteWarning(datasetId, datasetName);
                } else {
                    performDelete(datasetId, datasetName);
                }
            };
            
            function showDeleteWarning(datasetId, datasetName) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4 relative">
                        <!-- Close button -->
                        <button class="absolute top-3 right-3 text-text-secondary hover:text-primary transition-colors" onclick="closeDeleteModal()">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                        
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-primary">Delete Dataset</h3>
                                <p class="text-sm text-text-secondary">This action cannot be undone</p>
                            </div>
                        </div>
                        <p class="text-text-primary mb-4">
                            Are you sure you want to delete "<strong>${datasetName}</strong>"? 
                            This will permanently remove the dataset and all associated analysis history.
                        </p>
                        <div class="flex items-center mb-4">
                            <input type="checkbox" id="dont-show-again" class="rounded border-border text-primary focus:ring-primary-300 mr-2">
                            <label for="dont-show-again" class="text-sm text-text-secondary">Don't show this warning again</label>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button class="px-4 py-2 text-text-secondary hover:text-primary transition-colors" onclick="closeDeleteModal()">
                                Cancel
                            </button>
                            <button style="background-color: #ef4444; color: white; border: 2px solid #dc2626; font-weight: 600; padding: 8px 16px; border-radius: 8px; cursor: pointer;" class="hover:bg-red-600 transition-colors" onclick="performDelete(${datasetId}, '${datasetName}')">
                                Delete Dataset
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Make functions globally available
            window.closeDeleteModal = function() {
                const modals = document.querySelectorAll('.fixed.inset-0');
                modals.forEach(modal => {
                    if (modal.classList.contains('bg-black')) {
                        modal.remove();
                    }
                });
            };
            
            window.performDelete = function(datasetId, datasetName) {
                const dontShowAgain = document.getElementById('dont-show-again')?.checked || false;
                
                // Update warning preferences if needed
                if (dontShowAgain) {
                    updateWarningPreference('delete', false);
                }
                
                // Close modal immediately
                closeDeleteModal();
                
                // Perform delete
                const formData = new FormData();
                formData.append('dataset_id', datasetId);
                
                fetch('{% url "delete_dataset" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove from datasets array
                        const index = datasets.findIndex(d => d.id === datasetId);
                        if (index !== -1) {
                            datasets.splice(index, 1);
                            
                            // Update current dataset index if needed
                            if (currentDatasetIndex === index) {
                                currentDatasetIndex = datasets.length > 0 ? 0 : -1;
                                // Clear state if we deleted the current dataset
                                if (window.currentDatasetId === datasetId) {
                                    clearStateFromStorage();
                                    window.currentDatasetId = null;
                                    window.currentDatasetName = null;
                                    window.currentSessionId = null;
                                }
                            } else if (currentDatasetIndex > index) {
                                currentDatasetIndex--;
                            }
                        }
                        
                        // Update displays
                        updateCurrentDatasetDisplay();
                        updateDatasetHistory();
                        updateDatasetCount();
                        
                        // Show success message
                        showSuccessMessage(data.message);
                    } else {
                        showErrorMessage(data.error);
                    }
                })
                .catch(error => {
                    console.error('Error deleting dataset:', error);
                    showErrorMessage('Error deleting dataset. Please try again.');
                });
            }
            
            function updateWarningPreference(type, showWarning) {
                const formData = new FormData();
                formData.append('warning_type', type);
                formData.append('show_warning', showWarning);
                
                fetch('{% url "update_warning_preferences" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        warningPreferences[type === 'delete' ? 'show_delete_warning' : 'show_multiselect_help'] = showWarning;
                    }
                })
                .catch(error => {
                    console.error('Error updating warning preferences:', error);
                });
            }
            
            function showSuccessMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
                messageDiv.textContent = message;
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    messageDiv.remove();
                }, 3000);
            }
            
            function showErrorMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded z-50';
                messageDiv.textContent = message;
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    messageDiv.remove();
                }, 3000);
            }
            
            // Multiselect functionality
            function toggleMultiselectMode() {
                multiselectMode = !multiselectMode;
                selectedDatasets.clear();
                
                const toggleBtn = document.getElementById('multiselect-toggle');
                const actionsDiv = document.getElementById('multiselect-actions');
                
                if (multiselectMode) {
                    toggleBtn.classList.add('text-primary');
                    actionsDiv.classList.remove('hidden');
                    
                    if (warningPreferences.show_multiselect_help) {
                        showMultiselectHelp();
                    }
                } else {
                    toggleBtn.classList.remove('text-primary');
                    actionsDiv.classList.add('hidden');
                }
                
                updateDatasetHistory();
                updateSelectedCount();
            }
            
            function showMultiselectHelp() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4 relative">
                        <!-- Close button -->
                        <button class="absolute top-3 right-3 text-text-secondary hover:text-primary transition-colors" onclick="closeMultiselectHelp()">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                        
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-primary">Multiselect Mode</h3>
                                <p class="text-sm text-text-secondary">Select multiple datasets</p>
                            </div>
                        </div>
                        <p class="text-text-primary mb-4">
                            You can now select multiple datasets by clicking on them. 
                            Selected datasets will be highlighted and you can delete them all at once.
                        </p>
                        <div class="flex items-center mb-4">
                            <input type="checkbox" id="dont-show-multiselect-help" class="rounded border-border text-primary focus:ring-primary-300 mr-2">
                            <label for="dont-show-multiselect-help" class="text-sm text-text-secondary">Don't show this help again</label>
                        </div>
                        <div class="flex justify-end">
                            <button style="background-color: #3b82f6; color: white; border: 2px solid #2563eb; font-weight: 600; padding: 8px 16px; border-radius: 8px; cursor: pointer;" class="hover:bg-blue-600 transition-colors" onclick="closeMultiselectHelp()">
                                Got it
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            window.closeMultiselectHelp = function() {
                const dontShowAgain = document.getElementById('dont-show-multiselect-help')?.checked || false;
                
                if (dontShowAgain) {
                    updateWarningPreference('multiselect', false);
                }
                
                const modals = document.querySelectorAll('.fixed.inset-0');
                modals.forEach(modal => {
                    if (modal.classList.contains('bg-black')) {
                        modal.remove();
                    }
                });
            };
            
            window.toggleDatasetSelection = function(datasetId) {
                if (selectedDatasets.has(datasetId)) {
                    selectedDatasets.delete(datasetId);
                } else {
                    selectedDatasets.add(datasetId);
                }
                
                updateDatasetHistory();
                updateSelectedCount();
            };
            
            function updateSelectedCount() {
                const countElement = document.getElementById('selected-count');
                if (countElement) {
                    countElement.textContent = `${selectedDatasets.size} selected`;
                }
            }
            
            window.deleteSelectedDatasets = function() {
                if (selectedDatasets.size === 0) return;
                
                const datasetNames = Array.from(selectedDatasets).map(id => {
                    const dataset = datasets.find(d => d.id === id);
                    return dataset ? dataset.name : 'Unknown';
                });
                
                if (warningPreferences.show_delete_warning) {
                    showDeleteMultipleWarning(Array.from(selectedDatasets), datasetNames);
                } else {
                    performDeleteMultiple(Array.from(selectedDatasets), datasetNames);
                }
            };
            
            function showDeleteMultipleWarning(datasetIds, datasetNames) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
                
                // Store the data in the modal element for later use
                modal.dataset.datasetIds = JSON.stringify(datasetIds);
                modal.dataset.datasetNames = JSON.stringify(datasetNames);
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4 relative">
                        <!-- Close button -->
                        <button class="absolute top-3 right-3 text-text-secondary hover:text-primary transition-colors" onclick="closeDeleteMultipleModal()">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                        
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-primary">Delete Multiple Datasets</h3>
                                <p class="text-sm text-text-secondary">This action cannot be undone</p>
                            </div>
                        </div>
                        <p class="text-text-primary mb-4">
                            Are you sure you want to delete <strong>${datasetNames.length}</strong> datasets? 
                            This will permanently remove them and all associated analysis history.
                        </p>
                        <div class="max-h-32 overflow-y-auto mb-4">
                            <p class="text-sm text-text-secondary mb-2">Datasets to delete:</p>
                            ${datasetNames.map(name => `<div class="text-sm text-text-primary">• ${name}</div>`).join('')}
                        </div>
                        <div class="flex items-center mb-4">
                            <input type="checkbox" id="dont-show-again-multiple" class="rounded border-border text-primary focus:ring-primary-300 mr-2">
                            <label for="dont-show-again-multiple" class="text-sm text-text-secondary">Don't show this warning again</label>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button class="px-4 py-2 text-text-secondary hover:text-primary transition-colors" onclick="closeDeleteMultipleModal()">
                                Cancel
                            </button>
                            <button style="background-color: #ef4444; color: white; border: 2px solid #dc2626; font-weight: 600; padding: 8px 16px; border-radius: 8px; cursor: pointer;" class="hover:bg-red-600 transition-colors" onclick="performDeleteMultipleFromModal()">
                                Delete All
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            window.closeDeleteMultipleModal = function() {
                const modals = document.querySelectorAll('.fixed.inset-0');
                modals.forEach(modal => {
                    if (modal.classList.contains('bg-black')) {
                        modal.remove();
                    }
                });
            };
            
            window.performDeleteMultipleFromModal = function() {
                const modal = document.querySelector('.fixed.inset-0.bg-black');
                if (!modal) return;
                
                const datasetIds = JSON.parse(modal.dataset.datasetIds);
                const datasetNames = JSON.parse(modal.dataset.datasetNames);
                
                performDeleteMultiple(datasetIds, datasetNames);
            };
            
            window.performDeleteMultiple = function(datasetIds, datasetNames) {
                const dontShowAgain = document.getElementById('dont-show-again-multiple')?.checked || false;
                
                if (dontShowAgain) {
                    updateWarningPreference('delete', false);
                }
                
                closeDeleteMultipleModal();
                
                // Delete datasets one by one
                let deletedCount = 0;
                const totalCount = datasetIds.length;
                
                datasetIds.forEach((datasetId, index) => {
                    const formData = new FormData();
                    formData.append('dataset_id', datasetId);
                    
                    fetch('{% url "delete_dataset" %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            deletedCount++;
                            
                            // Remove from datasets array
                            const datasetIndex = datasets.findIndex(d => d.id === datasetId);
                            if (datasetIndex !== -1) {
                                datasets.splice(datasetIndex, 1);
                                
                                // Update current dataset index if needed
                                if (currentDatasetIndex === datasetIndex) {
                                    currentDatasetIndex = datasets.length > 0 ? 0 : -1;
                                } else if (currentDatasetIndex > datasetIndex) {
                                    currentDatasetIndex--;
                                }
                            }
                            
                            // If all deletions are complete
                            if (deletedCount === totalCount) {
                                // Update displays
                                updateCurrentDatasetDisplay();
                                updateDatasetHistory();
                                updateDatasetCount();
                                
                                // Exit multiselect mode
                                toggleMultiselectMode();
                                
                                // Show success message
                                showSuccessMessage(`Successfully deleted ${deletedCount} datasets`);
                            }
                        } else {
                            showErrorMessage(`Error deleting dataset: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting dataset:', error);
                        showErrorMessage('Error deleting datasets. Please try again.');
                    });
                });
            }
            
            function showSummaryStatistics() {
                // Remove blank state message if it exists
                const blankStateMessage = document.querySelector('.blank-state-message');
                if (blankStateMessage) {
                    blankStateMessage.remove();
                }
                
                // Show summary statistics content
                document.getElementById('summary-statistics-content').classList.remove('hidden');
                document.getElementById('main-chart-container').classList.add('hidden');
                
                // Set current analysis type for AI chat
                currentAnalysisType = 'Summary Statistics';
                
                // Update AI context info if available
                if (aiContextInfo && currentDatasetName) {
                    aiContextInfo.textContent = `Dataset: ${currentDatasetName} | Analysis: ${currentAnalysisType}`;
                }
                
                // Get current dataset
                const currentDataset = datasets[currentDatasetIndex];
                console.log('Debug: Current dataset:', currentDataset);
                
                // Record the summary statistics interaction
                if (currentDataset) {
                    recordInteraction('summary_stats', `Viewed summary statistics for dataset: ${currentDataset.name}`, {
                        dataset_id: currentDataset.id,
                        dataset_name: currentDataset.name,
                        rows: currentDataset.rows,
                        columns: currentDataset.columns
                    });
                }
                
                // Fetch summary statistics from backend
                fetch(`{% url "get_summary_statistics" 0 %}`.replace('0', currentDataset.id))
                    .then(response => {
                        console.log('Debug: Response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Debug: Received data:', data);
                        
                        if (data.error) {
                            console.error('Error fetching summary statistics:', data.error);
                            return;
                        }
                        
                        // Update dataset overview
                        document.getElementById('total-rows').textContent = data.dataset_overview.total_rows.toLocaleString();
                        document.getElementById('total-columns').textContent = data.dataset_overview.total_columns;
                        document.getElementById('numeric-columns').textContent = data.dataset_overview.numeric_columns;
                        
                        // Update data quality metrics
                        document.getElementById('missing-values').textContent = data.data_quality.missing_values;
                        document.getElementById('duplicate-rows').textContent = data.data_quality.duplicate_rows;
                        document.getElementById('outliers-count').textContent = data.data_quality.outliers_count;
                        document.getElementById('data-completeness').textContent = data.data_quality.data_completeness;
                        
                        // Update distribution insights
                        document.getElementById('skewed-variables').textContent = data.distribution_insights.skewed_variables;
                        document.getElementById('normal-distribution').textContent = data.distribution_insights.normal_distribution;
                        document.getElementById('high-variance').textContent = data.distribution_insights.high_variance;
                        document.getElementById('zero-variance').textContent = data.distribution_insights.zero_variance;
                        
                        // Populate variable summary table
                        console.log('Debug: Variable summary data:', data.variable_summary);
                        populateVariableSummaryTableFromBackend(data.variable_summary);
                    })
                    .catch(error => {
                        console.error('Error fetching summary statistics:', error);
                        // Fallback to sample data if API fails
                        populateVariableSummaryTable();
                        updateDataQualityMetrics();
                    });
            }
            
            function populateVariableSummaryTableFromBackend(variables) {
                console.log('Debug: Populating variable summary table with', variables.length, 'variables');
                
                const tableBody = document.getElementById('variable-summary-table');
                
                tableBody.innerHTML = variables.map(variable => {
                    // Helper function to format numeric values
                    const formatValue = (value) => {
                        if (value === 'N/A' || value === null || value === undefined) {
                            return 'N/A';
                        }
                        if (typeof value === 'number') {
                            // Format large numbers with commas, small numbers with 2 decimal places
                            if (Math.abs(value) >= 1000) {
                                return value.toLocaleString();
                            } else {
                                return value.toFixed(2);
                            }
                        }
                        return value.toString();
                    };
                    
                    return `
                        <tr class="border-b border-border-light hover:bg-surface">
                            <td class="py-3 px-4 font-medium text-text-primary">${variable.name}</td>
                            <td class="text-right py-3 px-4 text-text-secondary">${variable.type}</td>
                            <td class="text-right py-3 px-4 text-text-secondary">${variable.count.toLocaleString()}</td>
                            <td class="text-right py-3 px-4 text-text-secondary">${formatValue(variable.mean)}</td>
                            <td class="text-right py-3 px-4 text-text-secondary">${formatValue(variable.std_dev)}</td>
                            <td class="text-right py-3 px-4 text-text-secondary">${formatValue(variable.min)}</td>
                            <td class="text-right py-3 px-4 text-text-secondary">${formatValue(variable.q25)}</td>
                            <td class="text-right py-3 px-4 text-text-secondary">${formatValue(variable.median)}</td>
                            <td class="text-right py-3 px-4 text-text-secondary">${formatValue(variable.q75)}</td>
                            <td class="text-right py-3 px-4 text-text-secondary">${formatValue(variable.max)}</td>
                        </tr>
                    `;
                }).join('');
                
                console.log('Debug: Variable summary table populated');
            }
            
            // Fallback functions for when API fails
            function populateVariableSummaryTable() {
                const tableBody = document.getElementById('variable-summary-table');
                
                // Sample variable data for demonstration
                const variables = [
                    {
                        name: 'Revenue',
                        type: 'Numeric',
                        count: 1247,
                        mean: 156847,
                        std_dev: 45231,
                        min: 23450,
                        q25: 123456,
                        median: 145678,
                        q75: 189234,
                        max: 298765
                    },
                    {
                        name: 'Marketing_Spend',
                        type: 'Numeric',
                        count: 1247,
                        mean: 45678,
                        std_dev: 12345,
                        min: 12000,
                        q25: 34567,
                        median: 45678,
                        q75: 56789,
                        max: 89000
                    },
                    {
                        name: 'Customer_Satisfaction',
                        type: 'Numeric',
                        count: 1247,
                        mean: 4.2,
                        std_dev: 0.8,
                        min: 1.0,
                        q25: 3.8,
                        median: 4.3,
                        q75: 4.7,
                        max: 5.0
                    },
                    {
                        name: 'Region',
                        type: 'Categorical',
                        count: 1247,
                        mean: 'N/A',
                        std_dev: 'N/A',
                        min: 'N/A',
                        q25: 'N/A',
                        median: 'N/A',
                        q75: 'N/A',
                        max: 'N/A'
                    },
                    {
                        name: 'Product_Category',
                        type: 'Categorical',
                        count: 1247,
                        mean: 'N/A',
                        std_dev: 'N/A',
                        min: 'N/A',
                        q25: 'N/A',
                        median: 'N/A',
                        q75: 'N/A',
                        max: 'N/A'
                    }
                ];
                
                tableBody.innerHTML = variables.map(variable => `
                    <tr class="border-b border-border-light hover:bg-surface">
                        <td class="py-3 px-4 font-medium text-text-primary">${variable.name}</td>
                        <td class="text-right py-3 px-4 text-text-secondary">${variable.type}</td>
                        <td class="text-right py-3 px-4 text-text-secondary">${variable.count.toLocaleString()}</td>
                        <td class="text-right py-3 px-4 text-text-secondary">${variable.mean === 'N/A' ? 'N/A' : variable.mean.toLocaleString()}</td>
                        <td class="text-right py-3 px-4 text-text-secondary">${variable.std_dev === 'N/A' ? 'N/A' : variable.std_dev.toLocaleString()}</td>
                        <td class="text-right py-3 px-4 text-text-secondary">${variable.min === 'N/A' ? 'N/A' : variable.min.toLocaleString()}</td>
                        <td class="text-right py-3 px-4 text-text-secondary">${variable.q25 === 'N/A' ? 'N/A' : variable.q25.toLocaleString()}</td>
                        <td class="text-right py-3 px-4 text-text-secondary">${variable.median === 'N/A' ? 'N/A' : variable.median.toLocaleString()}</td>
                        <td class="text-right py-3 px-4 text-text-secondary">${variable.q75 === 'N/A' ? 'N/A' : variable.q75.toLocaleString()}</td>
                        <td class="text-right py-3 px-4 text-text-secondary">${variable.max === 'N/A' ? 'N/A' : variable.max.toLocaleString()}</td>
                    </tr>
                `).join('');
            }
            
            function updateDataQualityMetrics() {
                // Update data quality metrics with realistic values
                const currentDataset = datasets[currentDatasetIndex];
                
                // Calculate missing values percentage (random for demo)
                const missingPercentage = (Math.random() * 2).toFixed(1);
                document.getElementById('missing-values').textContent = missingPercentage + '%';
                
                // Calculate data completeness
                const completeness = (100 - parseFloat(missingPercentage)).toFixed(1);
                document.getElementById('data-completeness').textContent = completeness + '%';
                
                // Update other metrics
                document.getElementById('duplicate-rows').textContent = Math.floor(Math.random() * 5);
                document.getElementById('outliers-count').textContent = Math.floor(Math.random() * 20) + 5;
                document.getElementById('skewed-variables').textContent = Math.floor(Math.random() * 3) + 1;
                document.getElementById('normal-distribution').textContent = Math.floor(Math.random() * 4) + 2;
                document.getElementById('high-variance').textContent = Math.floor(Math.random() * 2) + 1;
                document.getElementById('zero-variance').textContent = 0;
            }
            
            // Confidence slider interaction
            const confidenceSlider = document.getElementById('confidence-slider');
            const confidenceValue = document.getElementById('confidence-value');
            
            confidenceSlider.addEventListener('input', function() {
                confidenceValue.textContent = this.value + '%';
            });
            
            // Tab switching
            const tabs = document.querySelectorAll('[id^="tab-"]');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    tabs.forEach(t => {
                        t.classList.remove('text-primary', 'border-b-2', 'border-primary');
                        t.classList.add('text-text-secondary');
                    });
                    
                    // Add active class to clicked tab
                    this.classList.remove('text-text-secondary');
                    this.classList.add('text-primary', 'border-b-2', 'border-primary');
                    
                    // Show appropriate content based on tab
                    const tabId = this.id;
                    if (tabId === 'tab-summary') {
                        // Show summary statistics content
                        document.getElementById('summary-statistics-content').classList.remove('hidden');
                        document.getElementById('main-chart-container').classList.add('hidden');
                    } else {
                        // Show main chart container for other tabs
                        document.getElementById('summary-statistics-content').classList.add('hidden');
                        document.getElementById('main-chart-container').classList.remove('hidden');
                        updateChart(tabId);
                    }
                });
            });
            
            // Run Analysis button
            document.getElementById('run-analysis').addEventListener('click', function() {
                this.innerHTML = '<svg class="w-4 h-4 mr-2 inline animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>Running...';
                
                setTimeout(() => {
                    this.innerHTML = '<svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>Run Analysis';
                    updateChart('tab-regression');
                }, 2000);
            });
            
            // AI Chat functionality
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-message');
            const chatMessages = document.getElementById('chat-messages');
            const passDataButton = document.getElementById('pass-data-to-ai');
            const aiContextInfo = document.getElementById('ai-context-info');
            
            // Make chat variables globally accessible
            window.chatMessages = chatMessages;
            window.chatInput = chatInput;
            window.currentSessionId = null;
            window.currentDatasetId = null;
            window.currentAnalysisType = null;
            window.conversationHistory = [];
            window.userInitials = '{{ user.first_name|first }}{{ user.last_name|first }}' || 'U';
            window.currentUserId = '{{ user.id }}' || 'anonymous';
            
            // Initialize chat session
            function initializeChatSession() {
                if (!window.chatMessages) {
                    console.error('Chat messages element not found');
                    return;
                }
                
                console.log('Initializing chat session...');
                window.conversationHistory = [];
                
                // Clear existing messages
                window.chatMessages.innerHTML = '';
                
                // Add initial greeting message
                const greetingMessage = document.createElement('div');
                greetingMessage.className = 'flex items-start';
                greetingMessage.innerHTML = `
                    <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div class="w-full max-w-full bg-white rounded-lg p-3 shadow-sm border border-gray-200 chat-content-resizable">
                        <p class="text-sm text-text-primary">👋 Hello! I'm your AI analytics assistant. I can help you interpret your data, explain patterns, and suggest insights. Upload a dataset and click "Pass Data to AI" to get started!</p>
                    </div>
                `;
                window.chatMessages.appendChild(greetingMessage);
                window.chatMessages.scrollTop = window.chatMessages.scrollHeight;
                console.log('Chat session initialized with greeting message');
            }
            
            // Make sendMessage globally accessible
            window.sendMessage = async function() {
                const message = window.chatInput.value.trim();
                if (!message) return;
                
                if (!window.currentDatasetId) {
                    alert('Please select a dataset first.');
                    return;
                }
                
                console.log('=== AI CHAT DEBUG START ===');
                console.log('Sending message:', message);
                console.log('Current dataset ID:', window.currentDatasetId);
                console.log('Current session ID:', window.currentSessionId);
                
                // Add user message to chat
                addChatMessage(message, 'user');
                window.chatInput.value = '';
                
                try {
                    const payload = {
                        message: message,
                        dataset_id: window.currentDatasetId,
                        session_id: window.currentSessionId
                    };
                    
                    console.log('Sending payload to backend:', payload);
                    
                    const response = await fetch('/api/v1/chat/send_message/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    console.log('Backend response status:', response.status);
                    console.log('Backend response headers:', Object.fromEntries(response.headers.entries()));
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('✅ AI Response received:', data);
                        console.log('AI Response content length:', data.response?.length || 0);
                        console.log('Session ID from response:', data.session_id);
                        console.log('Message ID from response:', data.message_id);
                        
                        addChatMessage(data.response, 'ai', data.message_id, false);
                        
                        // Update session ID if we got one
                        if (data.session_id) {
                            window.currentSessionId = data.session_id;
                            console.log('Updated session ID to:', window.currentSessionId);
                        }
                        
                        // Save state to localStorage after successful message
                        saveStateToStorage();
                        
                        console.log('=== AI CHAT DEBUG SUCCESS ===');
                    } else {
                        const errorText = await response.text();
                        console.error('❌ Backend error response:', errorText);
                        console.error('Response status:', response.status);
                        console.error('Response headers:', Object.fromEntries(response.headers.entries()));
                        
                        const error = await response.json().catch(() => ({ error: 'Failed to send message' }));
                        console.error('Parsed error:', error);
                        alert(error.error || 'Failed to send message');
                        
                        console.log('=== AI CHAT DEBUG ERROR ===');
                    }
                } catch (error) {
                    console.error('❌ Exception in sendMessage:', error);
                    console.error('Error name:', error.name);
                    console.error('Error message:', error.message);
                    console.error('Error stack:', error.stack);
                    alert('Failed to send message: ' + error.message);
                    
                    console.log('=== AI CHAT DEBUG EXCEPTION ===');
                }
            };
            
            // Global Download Report button (sticky at bottom of chat panel)
            const headerDlBtn = document.getElementById('download-report-btn');
            if (headerDlBtn && !headerDlBtn.dataset.bound) {
                headerDlBtn.dataset.bound = '1';
                headerDlBtn.addEventListener('click', () => {
                    if (!currentDatasetId || !currentSessionId) {
                        alert('Please select a dataset first.');
                        return;
                    }
                    const url = `/api/v1/report/download?dataset_id=${encodeURIComponent(currentDatasetId)}&session_id=${encodeURIComponent(currentSessionId)}`;
                    window.open(url, '_blank');
                });
            }
            
            // Initialize chat on page load
            // Wait for DOM to be fully loaded
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeChatSession);
            } else {
                initializeChatSession();
            }
            
            sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Wire Add summary to report
            const addSummaryBtn = document.getElementById('add-summary-to-report-btn');
            if (addSummaryBtn && !addSummaryBtn.dataset.bound) {
                addSummaryBtn.dataset.bound = '1';
                addSummaryBtn.addEventListener('click', async () => {
                    if (!window.currentDatasetId || !window.currentSessionId) {
                        alert('Please select a dataset first.');
                        return;
                    }
                    try {
                        const res = await fetch(`/api/summary-statistics/${window.currentDatasetId}/`);
                        if (!res.ok) throw new Error('Failed to load summary');
                        const summaryData = await res.json();
                        // cache for later if needed
                        window.__lastSummaryData = summaryData;

                        const payload = {
                            dataset_id: window.currentDatasetId,
                            session_id: window.currentSessionId,
                            title: 'Summary Statistics',
                            content: '', // let backend generate clean markdown
                            section_type: 'summary_statistics',
                            metadata: { analysis_type: 'summary_statistics' }
                        };
                        const saveRes = await fetch('/api/v1/report/add/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                            body: JSON.stringify(payload)
                        });
                        if (saveRes.ok) {
                            addSummaryBtn.textContent = 'Added';
                            addSummaryBtn.disabled = true;
                            addSummaryBtn.style.backgroundColor = '#16a34a';
                            addSummaryBtn.style.borderColor = '#15803d';
                        } else {
                            const err = await saveRes.json().catch(() => ({ error: 'Failed to add summary to report' }));
                            alert(err.error || 'Failed to add summary to report');
                        }
                    } catch (e) {
                        console.error(e);
                        alert('Failed to add summary to report');
                    }
                });
            }
            
            // Mobile responsiveness
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileOverlay = document.getElementById('mobile-overlay');
            
            // Chat Panel Resizing Functionality
            const resizeHandle = document.getElementById('resize-handle');
            
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;
            let originalWidth = 384; // w-96 = 24rem = 384px
            
            // Initialize resizable functionality
            function initializeResizableChat() {
                const chatPanel = document.getElementById('right-panel');
                if (!chatPanel || !resizeHandle) {
                    console.log('Resize initialization failed:', { chatPanel: !!chatPanel, resizeHandle: !!resizeHandle });
                    return;
                }
                
                console.log('Initializing resizable chat...');
                
                // Add resizable class to panel
                chatPanel.classList.add('resizable-panel');
                
                // Store original width
                originalWidth = chatPanel.offsetWidth;
                console.log('Original width:', originalWidth);
                
                // Add event listeners for resize handle
                resizeHandle.addEventListener('mousedown', startResize);
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);
                
                // Add double-click to reset size
                resizeHandle.addEventListener('dblclick', resetChatSize);
                
                // Add click event for testing
                resizeHandle.addEventListener('click', function(e) {
                    console.log('Resize handle clicked!');
                    e.stopPropagation();
                });
                
                // Add keyboard shortcuts
                document.addEventListener('keydown', handleKeyboardShortcuts);
                
                console.log('Resize event listeners attached successfully');
            }
            
            function startResize(e) {
                console.log('Start resize triggered');
                const chatPanel = document.getElementById('right-panel');
                if (!chatPanel) {
                    console.log('Chat panel not found in startResize');
                    return;
                }
                
                isResizing = true;
                startX = e.clientX;
                startWidth = chatPanel.offsetWidth;
                
                console.log('Resize started:', { startX, startWidth });
                
                // Add visual feedback
                document.body.style.cursor = 'col-resize';
                resizeHandle.style.backgroundColor = '#2563eb';
                
                // Prevent text selection
                e.preventDefault();
            }
            
            function resize(e) {
                if (!isResizing) return;
                
                const chatPanel = document.getElementById('right-panel');
                if (!chatPanel) return;
                
                const deltaX = startX - e.clientX;
                const newWidth = startWidth + deltaX;
                
                // Apply constraints
                const minWidth = 320;
                const maxWidth = 800;
                const constrainedWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
                
                // Update panel width
                chatPanel.style.width = constrainedWidth + 'px';
                
                // Update chat content sizing
                updateChatContentSizing(constrainedWidth);
                
                console.log('Resizing:', { deltaX, newWidth, constrainedWidth });
            }
            
            function stopResize() {
                if (!isResizing) return;
                
                const chatPanel = document.getElementById('right-panel');
                if (chatPanel) {
                    localStorage.setItem('chatPanelWidth', chatPanel.offsetWidth);
                }
                
                isResizing = false;
                
                // Remove visual feedback
                document.body.style.cursor = '';
                resizeHandle.style.backgroundColor = '';
            }
            
            function resetChatSize() {
                const chatPanel = document.getElementById('right-panel');
                if (chatPanel) {
                    chatPanel.style.width = originalWidth + 'px';
                    updateChatContentSizing(originalWidth);
                    localStorage.removeItem('chatPanelWidth');
                }
            }
            
            function updateChatContentSizing(width) {
                const isExpanded = width > 500;
                
                // Update message containers
                const chatMessages = document.getElementById('chat-messages');
                const chatInput = document.getElementById('chat-input');
                
                if (chatMessages) {
                    const messageContainers = chatMessages.querySelectorAll('.bg-accent-50, .bg-primary');
                    messageContainers.forEach(container => {
                        if (isExpanded) {
                            container.classList.add('chat-message-expanded');
                            container.classList.remove('max-w-xs');
                        } else {
                            container.classList.remove('chat-message-expanded');
                            container.classList.add('max-w-xs');
                        }
                    });
                }
                
                // Update input field
                if (chatInput) {
                    if (isExpanded) {
                        chatInput.classList.add('chat-input-expanded');
                    } else {
                        chatInput.classList.remove('chat-input-expanded');
                    }
                }
            }
            
            function handleKeyboardShortcuts(e) {
                // Ctrl/Cmd + R to reset chat size
                if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                    e.preventDefault();
                    resetChatSize();
                }
                
                // Ctrl/Cmd + Shift + R to toggle between original and expanded
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'R') {
                    e.preventDefault();
                    const chatPanel = document.getElementById('right-panel');
                    if (chatPanel) {
                        const currentWidth = chatPanel.offsetWidth;
                        if (currentWidth > originalWidth) {
                            resetChatSize();
                        } else {
                            chatPanel.style.width = '600px';
                            updateChatContentSizing(600);
                        }
                    }
                }
            }
            
            // Load saved size on page load
            function loadSavedChatSize() {
                const chatPanel = document.getElementById('right-panel');
                if (!chatPanel) return;
                
                const savedWidth = localStorage.getItem('chatPanelWidth');
                if (savedWidth) {
                    const width = parseInt(savedWidth);
                    if (width >= 320 && width <= 800) {
                        chatPanel.style.width = width + 'px';
                        updateChatContentSizing(width);
                    }
                }
            }
            
            // Initialize resizable chat on page load
            initializeResizableChat();
            loadSavedChatSize();
            
            mobileMenuBtn.addEventListener('click', function() {
                const leftPanel = document.getElementById('left-panel');
                const rightPanel = document.getElementById('right-panel');
                if (leftPanel && rightPanel) {
                leftPanel.classList.toggle('hidden');
                rightPanel.classList.toggle('hidden');
                mobileOverlay.classList.toggle('hidden');
                }
            });
            
            mobileOverlay.addEventListener('click', function() {
                const leftPanel = document.getElementById('left-panel');
                const rightPanel = document.getElementById('right-panel');
                if (leftPanel && rightPanel) {
                leftPanel.classList.add('hidden');
                rightPanel.classList.add('hidden');
                mobileOverlay.classList.add('hidden');
                }
            });
            
            // Contextual help
            const helpElements = document.querySelectorAll('[title]');
            const helpTooltip = document.getElementById('help-tooltip');
            const tooltipContent = document.getElementById('tooltip-content');
            
            helpElements.forEach(element => {
                element.addEventListener('mouseenter', function(e) {
                    tooltipContent.textContent = this.getAttribute('title');
                    helpTooltip.classList.remove('hidden');
                    
                    const rect = this.getBoundingClientRect();
                    helpTooltip.style.left = rect.left + 'px';
                    helpTooltip.style.top = (rect.bottom + 10) + 'px';
                });
                
                element.addEventListener('mouseleave', function() {
                    helpTooltip.classList.add('hidden');
                });
            });

            // Load chat history when dataset changes
            async function loadChatHistory() {
                if (!window.currentDatasetId) return;
                
                try {
                    const response = await fetch(`/api/v1/chat/history/?dataset_id=${window.currentDatasetId}&session_id=${window.currentSessionId || ''}`);
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Clear existing messages
                        window.chatMessages.innerHTML = '';
                        
                        // Add messages to chat
                        data.messages.forEach(message => {
                            if (message.type === 'user') {
                                addChatMessage(message.content, 'user');
                            } else if (message.type === 'ai') {
                                addChatMessage(message.content, 'ai', message.id, message.is_added_to_report);
                            }
                        });
                        
                        // Update session ID if we got one
                        if (data.session_id) {
                            window.currentSessionId = data.session_id;
                        }
                        
                        // Scroll to bottom
                        window.chatMessages.scrollTop = window.chatMessages.scrollHeight;
                    }
                } catch (error) {
                    console.error('Error loading chat history:', error);
                }
            }

            // Function to select a dataset from history
            function selectDatasetFromHistory(datasetId) {
                if (!datasetId) return;
                
                // Update current dataset
                window.currentDatasetId = datasetId;
                
                // Find the dataset in our list
                const dataset = datasets.find(d => d.id === datasetId);
                if (dataset) {
                    currentDatasetIndex = datasets.indexOf(dataset);
                    updateCurrentDatasetDisplay(dataset);
                    
                    // Set as current dataset in backend
                    saveCurrentDataset(datasetId);
                    
                    // Load chat history for this dataset
                    loadChatHistory();
                    
                    // Save state to localStorage
                    saveStateToStorage();
                }
            }

            // Load user state and initialize
            loadUserState();
            loadWarningPreferences();
            
            // Add event listener for page unload to save state
            window.addEventListener('beforeunload', function() {
                saveStateToStorage();
            });
            
            // Add event listener for page visibility change to save state
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden') {
                    saveStateToStorage();
                }
            });
            
            // Add event listener for browser navigation to restore state
            window.addEventListener('popstate', function() {
                // Restore state when navigating back/forward
                const stateRestored = loadStateFromStorage();
                if (stateRestored) {
                    // Reload user state to ensure consistency
                    loadUserState();
                }
            });
            
            // Add event listener for multiselect toggle
            document.getElementById('multiselect-toggle').addEventListener('click', toggleMultiselectMode);
            
            // Add logout handler to clear state
            const logoutLinks = document.querySelectorAll('a[href*="signout"], a[href*="logout"]');
            logoutLinks.forEach(link => {
                link.addEventListener('click', function() {
                    clearStateFromStorage();
                });
            });

            // Pass data to AI
            passDataButton.addEventListener('click', function() {
                if (window.currentDatasetId) {
                    // Update context info
                    aiContextInfo.textContent = `Dataset: ${window.currentDatasetName || 'Current Dataset'} | Analysis: ${window.currentAnalysisType || 'Summary Statistics'}`;
                    
                    // Add system message to chat
                    const systemMessage = document.createElement('div');
                    systemMessage.className = 'flex items-start';
                    systemMessage.innerHTML = `
                        <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="w-full max-w-full bg-white rounded-lg p-3 shadow-sm border border-gray-200 chat-content-resizable">
                            <p class="text-sm text-text-primary">✅ Data context loaded! I now have access to your dataset and analysis results. I can help you interpret the statistics, explain patterns, and suggest next steps. What would you like to explore?</p>
                        </div>
                    `;
                    window.chatMessages.appendChild(systemMessage);
                    window.chatMessages.scrollTop = window.chatMessages.scrollHeight;
                    
                    // Store context in conversation history
                    window.conversationHistory.push({
                        role: 'system',
                        content: `Dataset loaded: ${window.currentDatasetName || 'Current Dataset'} | Analysis type: ${window.currentAnalysisType || 'Summary Statistics'}`
                    });
                    
                    // Update button state
                    this.disabled = true;
                    this.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Data Loaded';
                    this.classList.remove('btn-accent');
                    this.classList.add('bg-success', 'text-white');
                } else {
                    // Show error if no dataset
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'flex items-start';
                    errorMessage.innerHTML = `
                        <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="w-full max-w-full bg-white rounded-lg p-3 shadow-sm border border-gray-200 chat-content-resizable">
                            <p class="text-sm text-text-primary">⚠️ Please upload a dataset first before passing data to AI.</p>
                        </div>
                    `;
                    window.chatMessages.appendChild(errorMessage);
                    window.chatMessages.scrollTop = window.chatMessages.scrollHeight;
                }
            });
            

        });
        
        // Helper function to format AI responses with proper HTML structure
        function formatAIResponse(response) {
            // Convert markdown-style formatting to HTML
            let formattedResponse = response
                // Convert **text** to <strong>text</strong>
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Convert *text* to <em>text</em>
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Convert bullet points to proper HTML lists
                .replace(/^\s*•\s*(.*)$/gm, '<li>$1</li>')
                .replace(/^\s*-\s*(.*)$/gm, '<li>$1</li>')
                // Convert numbered lists
                .replace(/^\s*(\d+)\.\s*(.*)$/gm, '<li>$2</li>')
                // Convert headers (## text to h3)
                .replace(/^##\s*(.*)$/gm, '<h3 class="text-base font-semibold text-primary mb-2 mt-3">$1</h3>')
                // Convert subheaders (### text to h4)
                .replace(/^###\s*(.*)$/gm, '<h4 class="text-sm font-semibold text-primary mb-1 mt-2">$1</h4>')
                // Convert code blocks
                .replace(/`([^`]+)`/g, '<code class="bg-gray-100 px-1 py-0.5 rounded text-xs font-mono">$1</code>');
            
            // Format tables - convert markdown tables to HTML tables
            formattedResponse = formattedResponse.replace(/\|(.+)\|/g, function(match, row) {
                const cells = row.split('|').map(cell => cell.trim());
                return '<tr>' + cells.map(cell => `<td class="px-2 py-1 border border-gray-300 text-xs">${cell}</td>`).join('') + '</tr>';
            });
            
            // Wrap table rows in proper table structure
            formattedResponse = formattedResponse.replace(/(<tr>.*<\/tr>)/gs, function(match) {
                return '<div class="overflow-x-auto mb-3"><table class="min-w-full border border-gray-300 text-xs">' + match + '</table></div>';
            });
            
            // Handle table headers (lines with dashes after table rows)
            formattedResponse = formattedResponse.replace(/\|(\s*[-:]+\s*\|)+/g, '');
            
            // Wrap lists in proper HTML structure
            formattedResponse = formattedResponse
                .replace(/(<li>.*<\/li>)/gs, '<ul class="list-disc list-inside space-y-1 mb-3">$1</ul>')
                .replace(/<\/ul>\s*<ul/g, '</ul><ul');
            
            // Split into paragraphs and wrap in proper HTML
            const paragraphs = formattedResponse.split('\n\n').filter(p => p.trim());
            const formattedParagraphs = paragraphs.map(p => {
                if (p.startsWith('<h3') || p.startsWith('<h4') || p.startsWith('<ul') || p.startsWith('<div class="overflow-x-auto')) {
                    return p;
                } else if (p.trim()) {
                    return `<p class="text-sm text-text-primary mb-2 leading-relaxed">${p}</p>`;
                }
                return '';
            }).join('');
            
            return formattedParagraphs;
        }
        
        // Helper function to get CSRF token - globally accessible
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // D3.js Chart Implementation
        function initializeChart() {
            const margin = {top: 20, right: 30, bottom: 40, left: 50};
            const width = 800 - margin.left - margin.right;
            const height = 350 - margin.bottom - margin.top;
            
            // Sample data
            const data = [
                {x: 10000, y: 65000}, {x: 15000, y: 89000}, {x: 20000, y: 112000},
                {x: 25000, y: 135000}, {x: 30000, y: 158000}, {x: 35000, y: 181000},
                {x: 40000, y: 204000}, {x: 45000, y: 227000}, {x: 50000, y: 250000},
                {x: 55000, y: 273000}, {x: 60000, y: 296000}, {x: 65000, y: 319000}
            ];
            
            const svg = d3.select('#main-chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Scales
            const xScale = d3.scaleLinear()
                .domain(d3.extent(data, d => d.x))
                .range([0, width]);
            
            const yScale = d3.scaleLinear()
                .domain(d3.extent(data, d => d.y))
                .range([height, 0]);
            
            // Line generator
            const line = d3.line()
                .x(d => xScale(d.x))
                .y(d => yScale(d.y))
                .curve(d3.curveMonotoneX);
            
            // Add axes
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale).tickFormat(d => '$' + d3.format('.0s')(d)));
            
            svg.append('g')
                .call(d3.axisLeft(yScale).tickFormat(d => '$' + d3.format('.0s')(d)));
            
            // Add axis labels
            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - margin.left)
                .attr('x', 0 - (height / 2))
                .attr('dy', '1em')
                .style('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('fill', '#718096')
                .text('Revenue ($)');
            
            svg.append('text')
                .attr('transform', `translate(${width / 2}, ${height + margin.bottom})`)
                .style('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('fill', '#718096')
                .text('Marketing Spend ($)');
            
            // Add regression line
            svg.append('path')
                .datum(data)
                .attr('fill', 'none')
                .attr('stroke', '#38b2ac')
                .attr('stroke-width', 3)
                .attr('d', line);
            
            // Add data points
            svg.selectAll('.dot')
                .data(data)
                .enter().append('circle')
                .attr('class', 'dot')
                .attr('cx', d => xScale(d.x))
                .attr('cy', d => yScale(d.y))
                .attr('r', 5)
                .attr('fill', '#1a365d')
                .attr('opacity', 0.7)
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('r', 7).attr('opacity', 1);
                    
                    // Add tooltip
                    const tooltip = svg.append('g')
                        .attr('id', 'tooltip');
                    
                    const rect = tooltip.append('rect')
                        .attr('x', xScale(d.x) + 10)
                        .attr('y', yScale(d.y) - 30)
                        .attr('width', 120)
                        .attr('height', 25)
                        .attr('fill', '#1a365d')
                        .attr('rx', 4);
                    
                    tooltip.append('text')
                        .attr('x', xScale(d.x) + 15)
                        .attr('y', yScale(d.y) - 12)
                        .attr('fill', 'white')
                        .style('font-size', '12px')
                        .text(`$${d3.format(',')(d.x)} → $${d3.format(',')(d.y)}`);
                })
                .on('mouseout', function() {
                    d3.select(this).attr('r', 5).attr('opacity', 0.7);
                    svg.select('#tooltip').remove();
                });
        }
        
        function updateChart(tabId) {
            // Check if there's a current dataset
            if (datasets.length === 0 || currentDatasetIndex === -1) {
                // No dataset selected, show blank state
                showBlankState();
                return;
            }
            
            // Remove blank state message if it exists
            const blankStateMessage = document.querySelector('.blank-state-message');
            if (blankStateMessage) {
                blankStateMessage.remove();
            }
            
            // Simulate chart updates based on tab selection
            const chartContainer = document.getElementById('main-chart');
            
            // Add loading state
            chartContainer.style.opacity = '0.5';
            
            setTimeout(() => {
                chartContainer.style.opacity = '1';
                
                // Update chart title based on tab
                const titles = {
                    'tab-distributions': 'Variable Distributions',
                    'tab-correlation': 'Variable Correlation Matrix',
                    'tab-outliers': 'Outlier Analysis',
                    'tab-summary': 'Summary Statistics Overview'
                };
                
                const titleElement = chartContainer.parentElement.querySelector('h3');
                if (titleElement && titles[tabId]) {
                    titleElement.textContent = titles[tabId];
                }
            }, 500);
        }

        function addChatMessage(content, sender, messageId = null, isAddedToReport = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} mb-4`;
            
            const messageContent = document.createElement('div');
            messageContent.className = `w-full max-w-full px-4 py-3 rounded-lg shadow-sm border ${
                sender === 'user' 
                    ? 'bg-primary text-white border-primary-dark' 
                    : 'bg-white text-gray-800 border-gray-200'
            }`;
            
            if (sender === 'ai') {
                // Extract tables and images for report inclusion BEFORE formatting
                let reportData = {
                    content: content,
                    tables: [],
                    images: []
                };
                
                // Extract markdown tables from the original content FIRST
                const lines = content.split('\n');
                let currentTable = [];
                let tableIndex = 0;
                let extractedTableContent = new Set(); // Track extracted table content
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.match(/^\|(.+)\|$/)) {
                        // This is a table row
                        currentTable.push(line);
                    } else if (line.match(/^\|(\s*[-:]+\s*\|)+$/)) {
                        // This is a table separator (dashes)
                        currentTable.push(line);
                    } else if (currentTable.length > 0) {
                        // End of table, process it
                        if (currentTable.length > 1) { // At least header + separator
                            const tableText = currentTable.join('\n');
                            const tableData = {
                                id: `markdown_table_${Date.now()}_${tableIndex}`,
                                markdown: tableText,
                                text: tableText,
                                type: 'markdown'
                            };
                            reportData.tables.push(tableData);
                            extractedTableContent.add(tableText.trim()); // Track this table
                            console.log(`📊 Extracted markdown table ${tableIndex + 1}:`, tableData);
                            tableIndex++;
                        }
                        currentTable = [];
                    }
                }
                
                // Process any remaining table
                if (currentTable.length > 1) {
                    const tableText = currentTable.join('\n');
                    const tableData = {
                        id: `markdown_table_${Date.now()}_${tableIndex}`,
                        markdown: tableText,
                        text: tableText,
                        type: 'markdown'
                    };
                    reportData.tables.push(tableData);
                    extractedTableContent.add(tableText.trim()); // Track this table
                    console.log(`📊 Extracted markdown table ${tableIndex + 1}:`, tableData);
                }
                
                // Now format the AI response
                const formattedContent = formatAIResponse(content);
                messageContent.innerHTML = formattedContent;
                
                // Extract HTML tables from the formatted content (EXCLUDE already extracted markdown tables)
                const tableElements = messageContent.querySelectorAll('table');
                tableElements.forEach((table, index) => {
                    const tableText = table.textContent.trim();
                    const tableHTML = table.outerHTML;
                    
                    // Check if this table content was already extracted as markdown
                    let isAlreadyExtracted = false;
                    for (const extractedContent of extractedTableContent) {
                        // Compare the text content to see if it's the same table
                        if (tableText.includes(extractedContent.replace(/\|/g, '').replace(/\n/g, ' ').trim()) ||
                            extractedContent.replace(/\|/g, '').replace(/\n/g, ' ').trim().includes(tableText)) {
                            isAlreadyExtracted = true;
                            console.log(`⚠️ Skipping HTML table ${index + 1} - already extracted as markdown`);
                            break;
                        }
                    }
                    
                    if (!isAlreadyExtracted) {
                        const tableData = {
                            id: `html_table_${Date.now()}_${index}`,
                            html: tableHTML,
                            text: tableText,
                            type: 'html'
                        };
                        reportData.tables.push(tableData);
                        console.log(`📊 Extracted HTML table ${index + 1}:`, tableData);
                    }
                });
                
                // Extract images (if any are added in the future)
                const imageElements = messageContent.querySelectorAll('img');
                imageElements.forEach((img, index) => {
                    const imageData = {
                        id: `image_${Date.now()}_${index}`,
                        src: img.src,
                        alt: img.alt,
                        width: img.width,
                        height: img.height
                    };
                    reportData.images.push(imageData);
                    console.log(`🖼️ Extracted image ${index + 1}:`, imageData);
                });
                
                // Store report data for later use
                if (messageId) {
                    window.reportData = window.reportData || {};
                    window.reportData[messageId] = reportData;
                    console.log(`💾 Stored report data for message ${messageId}:`, reportData);
                }
                
                // Add "Add to report" button if not already added
                if (!isAddedToReport) {
                    const buttonDiv = document.createElement('div');
                    buttonDiv.className = 'mt-3 flex items-center space-x-2';
                    buttonDiv.innerHTML = `
                        <button data-role="add-to-report" class="px-3 py-1 rounded text-xs"
                                style="background-color:#2563eb;color:#ffffff;border:1px solid #1e40af;">Add to report</button>
                    `;
                    messageContent.appendChild(buttonDiv);
                    
                    // Add event listener for the button
                    const addBtn = messageContent.querySelector('button[data-role="add-to-report"]');
                    if (addBtn && messageId) {
                        addBtn.addEventListener('click', async () => {
                            console.log('=== ADD TO REPORT DEBUG START ===');
                            console.log('Add to report button clicked');
                            console.log('Message ID:', messageId);
                            console.log('Current dataset ID:', window.currentDatasetId);
                            console.log('Current session ID:', window.currentSessionId);
                            
                            if (!window.currentDatasetId || !window.currentSessionId) {
                                console.log('❌ Missing dataset or session ID');
                                alert('Please select a dataset first.');
                                return;
                            }
                            
                            try {
                                // Get the stored report data
                                const storedData = window.reportData?.[messageId] || { content: content, tables: [], images: [] };
                                console.log('📋 Using stored report data:', storedData);
                                
                                const payload = {
                                    dataset_id: window.currentDatasetId,
                                    session_id: window.currentSessionId,
                                    title: 'AI Analysis',
                                    content: content,
                                    section_type: 'ai_response',
                                    message_id: messageId,
                                    report_data: storedData  // Include tables and images
                                };
                                
                                console.log('Adding to report with payload:', payload);
                                
                                const res = await fetch('/api/v1/report/add/', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                                    body: JSON.stringify(payload)
                                });
                                
                                console.log('Add to report response status:', res.status);
                                console.log('Add to report response headers:', Object.fromEntries(res.headers.entries()));
                                
                                if (res.ok) {
                                    const responseData = await res.json();
                                    console.log('✅ Add to report success:', responseData);
                                    addBtn.textContent = 'Added';
                                    addBtn.disabled = true;
                                    addBtn.style.backgroundColor = '#10b981';
                                    addBtn.style.borderColor = '#059669';
                                    console.log('=== ADD TO REPORT DEBUG SUCCESS ===');
                                } else {
                                    const errorText = await res.text();
                                    console.error('❌ Add to report error response:', errorText);
                                    console.error('Response status:', res.status);
                                    const err = await res.json().catch(() => ({ error: 'Failed to add to report' }));
                                    console.error('Parsed error:', err);
                                    alert(err.error || 'Failed to add to report');
                                    console.log('=== ADD TO REPORT DEBUG ERROR ===');
                                }
                            } catch (e) {
                                console.error('❌ Exception in add to report:', e);
                                console.error('Error name:', e.name);
                                console.error('Error message:', e.message);
                                console.error('Error stack:', e.stack);
                                alert('Failed to add to report: ' + e.message);
                                console.log('=== ADD TO REPORT DEBUG EXCEPTION ===');
                            }
                        });
                    }
                } else {
                    // Show "Already added" indicator
                    const addedDiv = document.createElement('div');
                    addedDiv.className = 'mt-3 flex items-center space-x-2';
                    addedDiv.innerHTML = `
                        <span class="px-3 py-1 rounded text-xs"
                              style="background-color:#10b981;color:#ffffff;border:1px solid #059669;">✓ Added to report</span>
                    `;
                    messageContent.appendChild(addedDiv);
                }
            } else {
                messageContent.textContent = content;
            }
            
            messageDiv.appendChild(messageContent);
            window.chatMessages.appendChild(messageDiv);
            window.chatMessages.scrollTop = window.chatMessages.scrollHeight;
        }
    </script>
</body>
</html>